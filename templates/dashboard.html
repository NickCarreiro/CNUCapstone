{% extends "base.html" %}
{% macro render_folder_tree(node, prefix="") %}
  {% for name, children in node.items()|sort %}
    {% set path = name if prefix == "" else prefix ~ "/" ~ name %}
    {% set has_children = children|length > 0 %}
    <details class="tree-node" data-has-children="{{ 1 if has_children else 0 }}">
      <summary class="tree-summary" data-folder="{{ path }}">
        <span class="tree-label">{{ name }}</span>
      </summary>
      {% if has_children %}
        <div class="tree-children">
          {{ render_folder_tree(children, path) }}
        </div>
      {% endif %}
    </details>
  {% endfor %}
{% endmacro %}
{% macro render_vault_tree(node) %}
  {% for name, children in node.items()|sort if name != "__files__" %}
    {% set file_count = children.get("__files__")|length if children.get("__files__") else 0 %}
    {% set has_children = children|length > 1 or file_count > 0 %}
    <details class="tree-node" data-has-children="{{ 1 if has_children else 0 }}">
      <summary class="tree-summary">
        <span class="tree-label">{{ name }}</span>
        {% if file_count %}
          <span class="tree-count">{{ file_count }} file{{ "s" if file_count != 1 }}</span>
        {% endif %}
      </summary>
      <div class="tree-children">
        {{ render_vault_tree(children) }}
      </div>
    </details>
  {% endfor %}
{% endmacro %}
{% block content %}
<section class="card">
  <h1>Welcome</h1>
  <p class="muted">Upload files into your secure staging area.</p>
  <div class="actions">
    <a class="pill" href="/ui/totp">Manage TOTP</a>
  </div>
  <form method="post" action="/ui/folder" class="form compact">
    <label>
      <span>Create folder (relative to your vault)</span>
      <input type="text" name="folder" placeholder="projects/phase1" required />
    </label>
    <button type="submit">Create folder</button>
  </form>
  <form method="post" action="/ui/upload" enctype="multipart/form-data" class="form">
    <label>
      <span>Folder (optional)</span>
      <input type="text" name="folder" placeholder="projects/phase1" />
    </label>
    <label>
      <span>Select file</span>
      <input type="file" name="file" required />
    </label>
    <button type="submit">Upload</button>
  </form>
</section>
<section class="card">
  <div class="card-header">
    <h2>Vault structure</h2>
  </div>
  <p class="muted">
    Browse the folders and files stored in your vault.
  </p>
  <div class="folder-tree tree-panel">
    <div class="tree">
      <div class="tree-root" aria-hidden="true">/</div>
      {{ render_vault_tree(vault_tree) }}
    </div>
  </div>
</section>
<section class="card">
  <div class="card-header">
    <h2>Your files</h2>
    <div class="card-tools">
      <input type="text" id="fileFilter" placeholder="Search files..." />
    </div>
  </div>
  {% if files %}
    <div class="table-wrap">
    <table class="table" id="fileTable">
      <thead>
        <tr>
          <th class="resizable">Item</th>
          <th class="resizable">Size (bytes)</th>
          <th class="resizable">Uploaded</th>
          <th>Preview</th>
          <th>Open</th>
          <th>Rename</th>
          <th>Trash</th>
          <th>Move</th>
        </tr>
      </thead>
      <tbody>
        {% for f in files %}
        <tr class="file-row">
          <td>
            <button
              type="button"
              class="file-name"
              data-file-token="{{ f.token }}"
            >
              {{ f.display_name }}
            </button>
          </td>
          <td>{{ f.record.file_size }}</td>
          <td>{{ f.record.uploaded_at }}</td>
          <td>
            <button
              type="button"
              class="pill preview-btn"
              data-file-token="{{ f.token }}"
              data-display-name="{{ f.display_name }}"
            >
              Preview
            </button>
          </td>
          <td>
            <a class="pill" href="/ui/files/{{ f.token }}">Open</a>
          </td>
          <td>
            <button
              type="button"
              class="pill rename-btn"
              data-file-token="{{ f.token }}"
              data-display-name="{{ f.display_name }}"
            >
              Rename
            </button>
          </td>
          <td>
            <form method="post" action="/ui/trash" class="inline-form">
              <input type="hidden" name="file_token" value="{{ f.token }}" />
              <button type="submit" class="danger">Trash</button>
            </form>
          </td>
          <td>
            <button
              type="button"
              class="pill move-btn"
              data-file-token="{{ f.token }}"
              data-display-name="{{ f.display_name }}"
            >
              Move
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <p class="muted">No files yet.</p>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<dialog id="fileNameDialog" class="modal">
  <div class="modal-header">
    <div class="modal-header-text">
      <h2>File name</h2>
      <p class="muted">Full file name (fetched securely).</p>
    </div>
    <div class="modal-header-actions">
      <button type="button" class="ghost" id="closeFileName">Close</button>
    </div>
  </div>
  <div class="modal-body">
    <p id="fileNameValue" class="file-name-full"></p>
  </div>
</dialog>
<dialog id="previewDialog" class="modal modal-wide">
  <div class="modal-header">
    <div class="modal-header-text">
      <h2 id="previewTitle">Preview</h2>
      <p class="muted" id="previewSubtitle"></p>
    </div>
    <div class="modal-header-actions">
      <a class="pill" id="previewOpen" target="_blank" rel="noopener">Open</a>
      <a class="pill" id="previewDownload">Download</a>
      <button type="button" class="ghost" id="closePreview">Close</button>
    </div>
  </div>
  <div class="preview-body">
    <iframe id="previewFrame" title="File preview"></iframe>
    <p class="muted" id="previewFallback">
      If the preview does not load, try Open (new tab) or Download.
    </p>
  </div>
</dialog>

<dialog id="moveDialog" class="modal">
  <form method="post" action="/ui/move" class="form">
    <input type="hidden" name="file_token" id="moveFileId" />
    <h2 id="moveTitle">Move file</h2>
    <p class="muted" id="moveSubtitle"></p>
    <label>
      <span>New folder (relative to your vault)</span>
      <input type="text" name="new_folder" id="moveFolderInput" placeholder="projects/phase2" list="folderList" />
      <datalist id="folderList">
        {% for folder in folders %}
          {% if folder.path != "" %}
            <option value="{{ folder.path }}"></option>
          {% endif %}
        {% endfor %}
      </datalist>
    </label>
    <div class="folder-tree">
      <div class="label">Existing folders</div>
      <div class="tree">
        <button type="button" class="tree-root" id="treeRoot" data-folder="">
          /
        </button>
        {{ render_folder_tree(folder_tree) }}
      </div>
    </div>
    <div class="modal-actions">
      <button type="submit">Move</button>
      <button type="button" class="ghost" id="cancelMove">Cancel</button>
    </div>
  </form>
</dialog>

<dialog id="renameDialog" class="modal">
  <form method="post" action="/ui/rename" class="form">
    <input type="hidden" name="file_token" id="renameFileId" />
    <h2 id="renameTitle">Rename</h2>
    <label>
      <span>New name</span>
      <input type="text" name="new_name" id="renameInput" required />
    </label>
    <div class="modal-actions">
      <button type="submit">Rename</button>
      <button type="button" class="ghost" id="cancelRename">Cancel</button>
    </div>
  </form>
</dialog>

<script>
  const dialog = document.getElementById("moveDialog");
  const moveFileId = document.getElementById("moveFileId");
  const moveTitle = document.getElementById("moveTitle");
  const moveSubtitle = document.getElementById("moveSubtitle");
  const cancelMove = document.getElementById("cancelMove");
  const moveFolderInput = document.getElementById("moveFolderInput");
  const treeRoot = document.getElementById("treeRoot");
  const treeSummaries = document.querySelectorAll(".tree-summary");

  const previewDialog = document.getElementById("previewDialog");
  const previewFrame = document.getElementById("previewFrame");
  const previewTitle = document.getElementById("previewTitle");
  const previewSubtitle = document.getElementById("previewSubtitle");
  const previewOpen = document.getElementById("previewOpen");
  const previewDownload = document.getElementById("previewDownload");
  const closePreview = document.getElementById("closePreview");

  const renameDialog = document.getElementById("renameDialog");
  const renameFileId = document.getElementById("renameFileId");
  const renameTitle = document.getElementById("renameTitle");
  const renameInput = document.getElementById("renameInput");
  const cancelRename = document.getElementById("cancelRename");
  const fileNameDialog = document.getElementById("fileNameDialog");
  const fileNameValue = document.getElementById("fileNameValue");
  const closeFileName = document.getElementById("closeFileName");
  const nameTooltip = document.createElement("div");
  nameTooltip.className = "file-name-tooltip";
  document.body.appendChild(nameTooltip);

  async function fetchFullName(token) {
    const res = await fetch(`/ui/file-name/${token}`, { cache: "no-store" });
    if (!res.ok) throw new Error("failed");
    const data = await res.json();
    return data.name || "";
  }

  closeFileName?.addEventListener("click", () => {
    if (typeof fileNameDialog.close === "function") {
      fileNameDialog.close();
    } else {
      fileNameDialog.removeAttribute("open");
    }
  });
  document.querySelectorAll(".move-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      moveFileId.value = btn.dataset.fileToken;
      moveTitle.textContent = `Move ${btn.dataset.displayName || "file"}`;
      moveSubtitle.textContent = "";
      if (typeof dialog.showModal === "function") {
        dialog.showModal();
      } else {
        dialog.setAttribute("open", "open");
      }
    });
  });

  cancelMove.addEventListener("click", () => {
    if (typeof dialog.close === "function") {
      dialog.close();
    } else {
      dialog.removeAttribute("open");
    }
  });

  function setMoveFolder(value, el) {
    moveFolderInput.value = value || "";
    document.querySelectorAll(".tree-summary.selected").forEach((n) => n.classList.remove("selected"));
    if (el) el.classList.add("selected");
  }

  treeRoot.addEventListener("click", () => setMoveFolder("", null));

  treeSummaries.forEach((item) => {
    item.addEventListener("click", () => setMoveFolder(item.dataset.folder, item));
  });

  const fileFilter = document.getElementById("fileFilter");
  const fileRows = document.querySelectorAll("#fileTable .file-row");
  fileFilter?.addEventListener("input", () => {
    const q = fileFilter.value.trim().toLowerCase();
    fileRows.forEach((row) => {
      row.hidden = q.length > 0 && !row.textContent.toLowerCase().includes(q);
    });
  });

  const fileTable = document.getElementById("fileTable");
  if (fileTable) {
    const headers = fileTable.querySelectorAll("th.resizable");
    headers.forEach((th) => {
      const handle = document.createElement("span");
      handle.className = "col-resizer";
      th.appendChild(handle);

      handle.addEventListener("mousedown", (e) => {
        e.preventDefault();
        const startX = e.clientX;
        const startWidth = th.offsetWidth;
        const index = Array.from(th.parentNode.children).indexOf(th);
        document.body.classList.add("resizing");

        function onMove(ev) {
          const delta = ev.clientX - startX;
          const nextWidth = Math.max(120, startWidth + delta);
          const cells = fileTable.querySelectorAll(`tr > *:nth-child(${index + 1})`);
          cells.forEach((cell) => {
            cell.style.width = `${nextWidth}px`;
            cell.style.maxWidth = `${nextWidth}px`;
          });
        }

        function onUp() {
          document.body.classList.remove("resizing");
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        }

        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
    });
  }

  document.querySelectorAll(".preview-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const url = `/ui/preview/${btn.dataset.fileToken}?v=${Date.now()}`;
      previewTitle.textContent = `Preview ${btn.dataset.displayName || "file"}`;
      previewSubtitle.textContent = "";
      previewOpen.href = url;
      previewDownload.href = `/ui/files/${btn.dataset.fileToken}?v=${Date.now()}`;
      previewFrame.src = url;
      if (typeof previewDialog.showModal === "function") {
        previewDialog.showModal();
      } else {
        previewDialog.setAttribute("open", "open");
      }
    });
  });

  closePreview.addEventListener("click", () => {
    previewFrame.src = "";
    if (typeof previewDialog.close === "function") {
      previewDialog.close();
    } else {
      previewDialog.removeAttribute("open");
    }
  });

  document.querySelectorAll(".rename-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      renameFileId.value = btn.dataset.fileToken;
      renameTitle.textContent = `Rename ${btn.dataset.displayName || "file"}`;
      renameInput.value = "";
      if (typeof renameDialog.showModal === "function") {
        renameDialog.showModal();
      } else {
        renameDialog.setAttribute("open", "open");
      }
      renameInput.focus();
      renameInput.select();
    });
  });

  cancelRename.addEventListener("click", () => {
    if (typeof renameDialog.close === "function") {
      renameDialog.close();
    } else {
      renameDialog.removeAttribute("open");
    }
  });

  document.querySelectorAll(".file-name").forEach((btn) => {
    let hoverTimer = null;
    btn.addEventListener("mouseenter", () => {
      hoverTimer = setTimeout(async () => {
        try {
          if (!btn.dataset.fullName) {
            btn.dataset.fullName = await fetchFullName(btn.dataset.fileToken);
          }
          if (btn.dataset.fullName) {
            nameTooltip.textContent = btn.dataset.fullName;
            const rect = btn.getBoundingClientRect();
            nameTooltip.style.left = `${rect.left + window.scrollX}px`;
            nameTooltip.style.top = `${rect.bottom + window.scrollY + 6}px`;
            nameTooltip.classList.add("show");
          }
        } catch {}
      }, 300);
    });
    btn.addEventListener("mouseleave", () => {
      if (hoverTimer) clearTimeout(hoverTimer);
      nameTooltip.classList.remove("show");
    });
    btn.addEventListener("click", async () => {
      try {
        if (!btn.dataset.fullName) {
          btn.dataset.fullName = await fetchFullName(btn.dataset.fileToken);
        }
        fileNameValue.textContent = btn.dataset.fullName || "Unavailable";
        if (typeof fileNameDialog.showModal === "function") {
          fileNameDialog.showModal();
        } else {
          fileNameDialog.setAttribute("open", "open");
        }
      } catch {
        fileNameValue.textContent = "Unavailable";
        if (typeof fileNameDialog.showModal === "function") {
          fileNameDialog.showModal();
        } else {
          fileNameDialog.setAttribute("open", "open");
        }
      }
    });
  });
</script>
{% endblock %}
