{% extends "base.html" %}
{% block body_class %}page-profile{% endblock %}
{% block content %}
<section class="card hero-card">
  <div class="eyebrow">Account</div>
  <h1>Profile</h1>
  <p class="muted">Manage identity, profile visibility, MFA, and security controls for your FileFort account.</p>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2>Interface mode</h2>
  </div>
  <p class="muted">Base mode is simplified. Advanced mode enables Terminal and Audit views.</p>
  <form method="post" action="/ui/profile/view-mode" class="form compact">
    <label class="toggle-row">
      <input type="checkbox" name="advanced_view" {% if ui_view_mode == "advanced" %}checked{% endif %} />
      <span>Enable advanced view (current interface)</span>
    </label>
    <div class="muted">
      Current mode:
      {% if ui_view_mode == "advanced" %}
      Advanced
      {% else %}
      Base
      {% endif %}
    </div>
    <div class="modal-actions">
      <button type="submit">Save view mode</button>
    </div>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Profile picture</h2>
  </div>
  <div class="profile-avatar-section">
    <div class="profile-avatar-large" aria-hidden="true">
      {% if user.profile_image_path %}
      <img src="/ui/profile/avatar" alt="" class="profile-avatar-large-img" />
      {% else %}
      {{ user.username[:1]|upper }}
      {% endif %}
    </div>
    <div class="profile-avatar-forms">
      <form method="post" action="/ui/profile/avatar" enctype="multipart/form-data" class="form compact">
        <label>
          <span>Upload profile picture</span>
          <input type="file" name="avatar" accept="image/png,image/jpeg,image/webp,image/gif" required />
        </label>
        <button type="submit">Upload profile picture</button>
      </form>
      {% if user.profile_image_path %}
      <form method="post" action="/ui/profile/avatar/remove" class="inline-form">
        <button type="submit" class="ghost">Remove picture</button>
      </form>
      {% endif %}
    </div>
  </div>
</section>

{% set email_configured = (user.email or "")|trim != "" %}
{% set email_verified = email_configured and user.email_verified %}
{% set email_channel_ready = email_verified and smtp_ready %}
{% set sms_phone_configured = (user.phone_number or "")|trim != "" %}
{% set sms_carrier_configured = (user.sms_carrier or "")|trim != "" %}
{% set sms_channel_ready = sms_phone_configured and sms_carrier_configured and sms_ready %}

<section class="card">
  <div class="card-header">
    <h2>MFA setup center</h2>
    <div class="card-tools">
      <a class="pill ghost" href="/ui/mfa">Open authenticator setup</a>
    </div>
  </div>
  <p class="muted">Set up methods in this order: contact channels, enable methods, then choose a default challenge method.</p>
  <div class="mfa-overview-grid">
    <article class="soft-panel mfa-method-card">
      <div class="mfa-method-head">
        <h3>Authenticator app</h3>
        <span class="mfa-status-badge {% if user.totp_enabled %}is-enabled{% else %}is-off{% endif %}">
          {% if user.totp_enabled %}Enabled{% else %}Not enabled{% endif %}
        </span>
      </div>
      <p class="muted">Best security option. Uses time-based one-time codes in an authenticator app.</p>
      <p class="mfa-method-detail">
        {% if user.totp_enabled %}
        Your account already has TOTP enabled.
        {% else %}
        Open MFA setup, scan the secret, then verify one code to turn it on.
        {% endif %}
      </p>
      <a class="pill" href="/ui/mfa">{% if user.totp_enabled %}Manage authenticator{% else %}Set up authenticator{% endif %}</a>
    </article>

    <article class="soft-panel mfa-method-card">
      <div class="mfa-method-head">
        <h3>Email code</h3>
        <span class="mfa-status-badge {% if user.email_mfa_enabled %}is-enabled{% elif email_channel_ready %}is-ready{% else %}is-warn{% endif %}">
          {% if user.email_mfa_enabled %}
          Enabled
          {% elif email_channel_ready %}
          Ready to enable
          {% elif not email_configured %}
          Email required
          {% elif not email_verified %}
          Verify required
          {% elif not smtp_ready %}
          Server unavailable
          {% else %}
          Not ready
          {% endif %}
        </span>
      </div>
      <p class="muted">Requires a verified email and SMTP configured on the server.</p>
      <p class="mfa-method-detail">
        Email:
        {% if email_configured %}<code>{{ user.email }}</code>{% else %}not set{% endif %}
        |
        Verification:
        {% if email_verified %}verified{% else %}not verified{% endif %}
      </p>
      <p class="mfa-method-detail">
        SMTP:
        {% if smtp_ready %}ready{% else %}not configured{% endif %}
      </p>
    </article>

    <article class="soft-panel mfa-method-card">
      <div class="mfa-method-head">
        <h3>SMS code</h3>
        <span class="mfa-status-badge {% if user.sms_mfa_enabled %}is-enabled{% elif sms_channel_ready %}is-ready{% else %}is-warn{% endif %}">
          {% if user.sms_mfa_enabled %}
          Enabled
          {% elif sms_channel_ready %}
          Ready to enable
          {% elif not sms_phone_configured %}
          Phone required
          {% elif not sms_carrier_configured %}
          Carrier required
          {% elif not sms_ready %}
          Delivery unavailable
          {% else %}
          Not ready
          {% endif %}
        </span>
      </div>
      <p class="muted">Requires a phone number, supported carrier, and working SMS transport.</p>
      <p class="mfa-method-detail">
        Phone:
        {% if sms_phone_configured %}<code>{{ user.phone_number }}</code>{% else %}not set{% endif %}
        |
        Carrier:
        {% if sms_carrier_configured %}<code>{{ sms_carrier_label or user.sms_carrier }}</code>{% else %}not set{% endif %}
      </p>
      <p class="mfa-method-detail">
        SMS mode: {{ sms_provider_label }} |
        Transport:
        {% if sms_ready %}ready{% else %}not configured{% endif %}
      </p>
    </article>
  </div>
  <p class="muted">
    Active methods:
    {% if mfa_methods_active %}
      {% for method in mfa_methods_active %}
      <code>{{ mfa_method_labels.get(method, method) }}</code>{% if not loop.last %}, {% endif %}
      {% endfor %}
    {% else %}
    none
    {% endif %}
    |
    Preferred:
    {% if mfa_method_preferred %}
    <code>{{ mfa_method_labels.get(mfa_method_preferred, mfa_method_preferred) }}</code>
    {% else %}
    not set
    {% endif %}
  </p>
</section>

<section class="card">
  <div class="card-header">
    <h2>Contact and MFA preferences</h2>
  </div>
  <p class="muted">Use this form to configure email/SMS channels and toggle delivery-based MFA methods.</p>
  <form method="post" action="/ui/profile/preferences" class="form compact profile-mfa-form">
    <div class="soft-panel profile-mfa-step">
      <h3>Step 1: Configure contact channels</h3>
      <div class="profile-mfa-grid">
        <label class="profile-mfa-field-full">
          <span>Email</span>
          <input type="email" name="email" value="{{ user.email or '' }}" placeholder="you@example.com" />
        </label>
        <label class="toggle-row profile-mfa-field-full">
          <input type="checkbox" name="email_visible" {% if user.email_visible %}checked{% endif %} />
          <span>Allow other users to see my verified email</span>
        </label>
        <div class="profile-mfa-field-full mfa-channel-status">
          Email status:
          {% if email_verified %}
          <code>verified</code>
          {% elif email_configured %}
          <code>not verified</code>
          {% else %}
          <code>not set</code>
          {% endif %}
        </div>

        <label>
          <span>Phone number</span>
          <input type="text" name="phone_number" value="{{ user.phone_number or '' }}" placeholder="+1 555 555 5555" />
        </label>
        <label>
          <span>Carrier (supported gateways)</span>
          <select name="sms_carrier">
            <option value="">Select carrier</option>
            {% for carrier in sms_carrier_options %}
            <option value="{{ carrier.value }}" {% if user.sms_carrier == carrier.value %}selected{% endif %}>{{ carrier.label }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="mfa-channel-status">
          SMTP:
          {% if smtp_ready %}
          <code>ready</code>
          {% else %}
          <code>not configured</code>
          {% endif %}
        </div>
        <div class="mfa-channel-status">
          SMS transport:
          {% if sms_ready %}
          <code>ready</code>
          {% else %}
          <code>not configured</code>
          {% endif %}
        </div>
      </div>
      <p class="muted">If you changed your email, save this form first, then send verification.</p>
    </div>

    <div class="soft-panel profile-mfa-step">
      <h3>Step 2: Enable or disable delivery MFA methods</h3>
      <label class="toggle-row">
        <input type="checkbox" name="email_mfa_enabled" {% if user.email_mfa_enabled %}checked{% endif %} />
        <span>Enable email MFA codes (requires verified email + SMTP)</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" name="sms_mfa_enabled" {% if user.sms_mfa_enabled %}checked{% endif %} />
        <span>Enable SMS MFA codes (requires phone + carrier + SMS transport)</span>
      </label>
      <div class="mfa-channel-status">SMS delivery mode: <code>{{ sms_provider_label }}</code></div>
      <div class="actions">
        <a class="pill ghost" href="/ui/mfa">Set up authenticator app (TOTP)</a>
      </div>
    </div>

    <div class="soft-panel profile-mfa-step">
      <h3>Step 3: Choose preferred challenge method</h3>
      <label>
        <span>Preferred MFA method</span>
        <select name="mfa_method">
          <option value="totp" {% if mfa_method_preferred == "totp" %}selected{% endif %}>Authenticator app (TOTP)</option>
          <option value="email" {% if mfa_method_preferred == "email" %}selected{% endif %}>Email code (SMTP)</option>
          <option value="sms" {% if mfa_method_preferred == "sms" %}selected{% endif %}>SMS code</option>
        </select>
      </label>
      <p class="muted">When multiple methods are active, this method is selected first during sign-in.</p>
    </div>

    <div class="modal-actions">
      <button type="submit">Save contact + MFA settings</button>
      <button
        type="submit"
        formaction="/ui/profile/email/send-verification"
        formmethod="post"
        class="ghost"
        {% if not user.email %}disabled{% endif %}
      >
        Send verification email
      </button>
    </div>
    <p class="muted">
      {% if smtp_ready %}
      Verification emails are delivered through the configured SMTP relay.
      {% else %}
      SMTP is not configured yet. Verification can still be generated as a manual link for development.
      {% endif %}
    </p>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Identity</h2>
  </div>
  <p class="muted">Change your username. Password is required. If MFA is enabled, you must provide a code.</p>
  <form method="post" action="/ui/profile/username" class="form compact">
    <label>
      <span>New username</span>
      <input type="text" name="username" value="{{ user.username }}" required />
    </label>
    <label>
      <span>Current password</span>
      <input type="password" name="password" required />
    </label>
    {% if user.totp_enabled %}
    <label>
      <span>MFA code</span>
      <input type="text" name="mfa_code" inputmode="numeric" pattern="[0-9]*" required />
    </label>
    {% endif %}
    <button type="submit">Update username</button>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Security</h2>
    <div class="card-tools">
      <a class="pill" href="/ui/mfa">Manage MFA</a>
    </div>
  </div>
  <p class="muted">Change your password. MFA is required when enabled. All sessions are revoked and you stay signed in.</p>
  <form method="post" action="/ui/profile/password" class="form compact">
    <label>
      <span>Current password</span>
      <input type="password" name="current_password" required />
    </label>
    <label>
      <span>New password</span>
      <input type="password" name="new_password" minlength="10" required />
    </label>
    <label>
      <span>Confirm new password</span>
      <input type="password" name="confirm_password" minlength="10" required />
    </label>
    {% if user.totp_enabled %}
    <label>
      <span>MFA code</span>
      <input type="text" name="mfa_code" inputmode="numeric" pattern="[0-9]*" required />
    </label>
    {% endif %}
    <button type="submit" class="danger">Update password</button>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Theme</h2>
  </div>
  <p class="muted">Theme and background are stored in this browser. System mode follows your device preference.</p>
  <div class="actions">
    <button type="button" class="pill" id="profileThemeSystem">System</button>
    <button type="button" class="pill" id="profileThemeLight">Light</button>
    <button type="button" class="pill" id="profileThemeDark">Dark</button>
  </div>
  <div class="actions">
    <button type="button" class="ghost" data-bg-preset="aurora">Aurora preset</button>
    <button type="button" class="ghost" data-bg-preset="slate">Slate preset</button>
    <button type="button" class="ghost" data-bg-preset="ember">Ember preset</button>
    <button type="button" class="ghost" id="profileBgReset">Reset background</button>
  </div>
  <div class="actions">
    <button type="button" class="ghost" data-accent-preset="cyan-amber">Cyan + amber</button>
    <button type="button" class="ghost" data-accent-preset="mint-coral">Mint + coral</button>
    <button type="button" class="ghost" data-accent-preset="violet-gold">Violet + gold</button>
    <button type="button" class="ghost" id="profileAccentReset">Reset colors</button>
  </div>
  <details class="soft-panel">
    <summary>Advanced background controls</summary>
    <form class="form compact" id="profileBgForm">
      <label>
        <span>Mode</span>
        <select id="profileBgMode">
          <option value="gradient">Gradient</option>
          <option value="solid">Solid color</option>
        </select>
      </label>
      <label>
        <span>Primary color</span>
        <input type="color" id="profileBgColorA" value="#0a152d" />
      </label>
      <label>
        <span>Secondary color</span>
        <input type="color" id="profileBgColorB" value="#001f2d" />
      </label>
      <button type="submit">Apply background</button>
    </form>
  </details>
  <details class="soft-panel">
    <summary>Advanced accent colors</summary>
    <form class="form compact" id="profileAccentForm">
      <label>
        <span>Primary accent</span>
        <input type="color" id="profileAccentColorA" value="#00c7ff" />
      </label>
      <label>
        <span>Secondary accent</span>
        <input type="color" id="profileAccentColorB" value="#ffbf3c" />
      </label>
      <button type="submit">Apply accent colors</button>
    </form>
  </details>
</section>

<script>
  (function () {
    const root = document.body;
    const themeApi = window.PFVTheme || null;
    const sys = document.getElementById("profileThemeSystem");
    const light = document.getElementById("profileThemeLight");
    const dark = document.getElementById("profileThemeDark");
    const bgPresetButtons = document.querySelectorAll("[data-bg-preset]");
    const accentPresetButtons = document.querySelectorAll("[data-accent-preset]");
    const bgReset = document.getElementById("profileBgReset");
    const bgForm = document.getElementById("profileBgForm");
    const bgMode = document.getElementById("profileBgMode");
    const bgColorA = document.getElementById("profileBgColorA");
    const bgColorB = document.getElementById("profileBgColorB");
    const accentReset = document.getElementById("profileAccentReset");
    const accentForm = document.getElementById("profileAccentForm");
    const accentColorA = document.getElementById("profileAccentColorA");
    const accentColorB = document.getElementById("profileAccentColorB");
    if (!sys || !light || !dark) return;

    function setStoredTheme(value) {
      if (themeApi && typeof themeApi.setThemePreference === "function") {
        themeApi.setThemePreference(value);
        return;
      }
      root.dataset.theme = value === "dark" ? "dark" : "light";
    }

    sys.addEventListener("click", () => setStoredTheme(""));
    light.addEventListener("click", () => setStoredTheme("light"));
    dark.addEventListener("click", () => setStoredTheme("dark"));

    function setBackgroundCss(css) {
      const value = String(css || "").trim();
      if (themeApi && typeof themeApi.setBackgroundCss === "function") {
        themeApi.setBackgroundCss(value);
        return;
      }
      if (value) root.style.setProperty("--pfv-custom-bg", value);
      else root.style.removeProperty("--pfv-custom-bg");
    }

    function setAccentColors(a, b) {
      if (themeApi && typeof themeApi.setAccentColors === "function") {
        themeApi.setAccentColors(a, b);
        return;
      }
      root.style.setProperty("--accent", a);
      root.style.setProperty("--accent-2", b);
    }

    const PRESETS = {
      aurora:
        "radial-gradient(1100px at 14% 0%, rgba(0,199,255,0.20), rgba(0,0,0,0) 54%), radial-gradient(980px at 98% 8%, rgba(255,191,60,0.18), rgba(0,0,0,0) 56%), linear-gradient(180deg, #050913 0%, #070d1b 56%, #050812 100%)",
      slate:
        "radial-gradient(980px at 6% 0%, rgba(115,172,255,0.14), rgba(0,0,0,0) 58%), linear-gradient(180deg, #0b1324 0%, #101a2d 54%, #0d1727 100%)",
      ember:
        "radial-gradient(900px at 96% 4%, rgba(255,143,69,0.22), rgba(0,0,0,0) 54%), radial-gradient(820px at 0% 100%, rgba(255,208,92,0.12), rgba(0,0,0,0) 56%), linear-gradient(180deg, #13090a 0%, #1a0e12 56%, #12080a 100%)",
    };
    const ACCENT_PRESETS = {
      "cyan-amber": ["#00c7ff", "#ffbf3c"],
      "mint-coral": ["#14d6a5", "#ff8d7a"],
      "violet-gold": ["#8a7dff", "#ffd26a"],
    };

    bgPresetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const preset = btn.dataset.bgPreset || "";
        if (!preset || !PRESETS[preset]) return;
        setBackgroundCss(PRESETS[preset]);
      });
    });

    bgReset?.addEventListener("click", () => setBackgroundCss(""));
    accentReset?.addEventListener("click", () => {
      if (themeApi && typeof themeApi.clearAccentColors === "function") {
        themeApi.clearAccentColors();
      } else {
        root.style.removeProperty("--accent");
        root.style.removeProperty("--accent-2");
      }
    });

    bgForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const mode = (bgMode?.value || "gradient").trim();
      const a = (bgColorA?.value || "#0a152d").trim();
      const b = (bgColorB?.value || "#001f2d").trim();
      if (mode === "solid") {
        setBackgroundCss(`linear-gradient(180deg, ${a} 0%, ${a} 100%)`);
      } else {
        setBackgroundCss(
          `radial-gradient(1000px at 10% 0%, color-mix(in srgb, ${a} 42%, transparent), rgba(0,0,0,0) 56%), radial-gradient(900px at 98% 8%, color-mix(in srgb, ${b} 34%, transparent), rgba(0,0,0,0) 58%), linear-gradient(180deg, ${a} 0%, ${b} 100%)`
        );
      }
    });

    accentPresetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const preset = btn.dataset.accentPreset || "";
        const pair = ACCENT_PRESETS[preset];
        if (!pair) return;
        if (accentColorA) accentColorA.value = pair[0];
        if (accentColorB) accentColorB.value = pair[1];
        setAccentColors(pair[0], pair[1]);
      });
    });

    accentForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const a = (accentColorA?.value || "#00c7ff").trim();
      const b = (accentColorB?.value || "#ffbf3c").trim();
      setAccentColors(a, b);
    });

    if (themeApi && typeof themeApi.getAccentColors === "function") {
      const current = themeApi.getAccentColors();
      if (current) {
        if (accentColorA) accentColorA.value = current.a;
        if (accentColorB) accentColorB.value = current.b;
      }
    }
  })();
</script>
{% endblock %}
