<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Personal File Vault" }}</title>
    <link rel="stylesheet" href="/static/style.css?v=6" />
  </head>
  <body data-theme="light">
    <div class="page">
      <header class="site-header">
        <div class="container header-inner">
          <div class="brand-group">
            <div class="brand">Personal File Vault</div>
            <div class="brand-sub">Single-host secure storage</div>
          </div>
          <div class="toolbar">
            {% if user %}
            <nav class="nav">
              <button type="button" class="nav-pill" id="pfvTerminalTab">Terminal</button>
              <a href="/ui">Dashboard</a>
              <a href="/ui/groups">Groups</a>
              <a href="/ui/trash">Trash</a>
            </nav>
            <div class="toolbar-actions">
              <div class="user-pill">Signed in</div>
              <button type="button" class="ghost toggle-theme" id="themeToggle">Dark mode</button>
              <a class="pill ghost-link" href="/ui/logout">Logout</a>
            </div>
            {% else %}
            <div class="toolbar-actions">
              <button type="button" class="ghost toggle-theme" id="themeToggle">Dark mode</button>
            </div>
            {% endif %}
          </div>
        </div>
      </header>
      <main class="content container">
        {% block content %}{% endblock %}
      </main>
      <footer class="site-footer">
        <div class="container footer-inner">Single-host secure storage</div>
      </footer>
    </div>
    {% block scripts %}{% endblock %}
    <script>
      const root = document.body;
      const toggle = document.getElementById("themeToggle");
      const stored = localStorage.getItem("pfv-theme");
      if (stored) {
        root.dataset.theme = stored;
        toggle.textContent = stored === "dark" ? "Light mode" : "Dark mode";
      }

      toggle.addEventListener("click", () => {
        const next = root.dataset.theme === "dark" ? "light" : "dark";
        root.dataset.theme = next;
        localStorage.setItem("pfv-theme", next);
        toggle.textContent = next === "dark" ? "Light mode" : "Dark mode";
      });
    </script>

    <div class="terminal" id="pfvTerminal" data-open="1" data-hidden="0" data-max="0" data-theme="dark">
      <div class="terminal-bar">
        <div class="terminal-left">
          <button type="button" class="terminal-dot dot-red" id="pfvTerminalClose" aria-label="Close terminal"></button>
          <button type="button" class="terminal-dot dot-yellow" id="pfvTerminalMinimize" aria-label="Minimize terminal"></button>
          <button type="button" class="terminal-dot dot-green" id="pfvTerminalMaximize" aria-label="Maximize terminal"></button>
          <span class="terminal-title">Vault Terminal</span>
        </div>
        <div class="terminal-actions">
          <button type="button" class="ghost" id="pfvTerminalToggle">Hide</button>
          <button type="button" class="ghost" id="pfvTerminalClear">Clear</button>
        </div>
      </div>
      <div class="terminal-body" id="pfvTerminalBody" role="log" aria-live="polite" aria-relevant="additions"></div>
      <form class="terminal-input" id="pfvTerminalForm">
        <input type="text" id="pfvTerminalCommand" name="command" placeholder="Type: list, move, copy, rename" autocomplete="off" />
        <button type="submit">Run</button>
      </form>
      <span class="resize-handle handle-e" data-resize="e"></span>
      <span class="resize-handle handle-w" data-resize="w"></span>
      <span class="resize-handle handle-n" data-resize="n"></span>
      <span class="resize-handle handle-s" data-resize="s"></span>
    </div>
    <button type="button" class="terminal-fab" id="pfvTerminalFab" hidden>Terminal</button>
    <button type="button" class="terminal-tab" id="pfvTerminalTab" hidden>Vault Terminal</button>

    <script>
      (function () {
        const term = document.getElementById("pfvTerminal");
        const body = document.getElementById("pfvTerminalBody");
        const toggleBtn = document.getElementById("pfvTerminalToggle");
        const clearBtn = document.getElementById("pfvTerminalClear");
        const closeDot = document.getElementById("pfvTerminalClose");
        const minDot = document.getElementById("pfvTerminalMinimize");
        const maxDot = document.getElementById("pfvTerminalMaximize");
        const fab = document.getElementById("pfvTerminalFab");
        const tab = document.getElementById("pfvTerminalTab");
        const termForm = document.getElementById("pfvTerminalForm");
        const termCommand = document.getElementById("pfvTerminalCommand");
        if (!term || !body || !toggleBtn || !clearBtn || !closeDot || !minDot || !maxDot || !fab || !tab) return;

        const openStored = localStorage.getItem("pfv-terminal-open");
        if (openStored === "0" || openStored === "1") {
          term.dataset.open = openStored;
        }
        term.dataset.min = term.dataset.open === "1" ? "0" : "1";
        const hiddenStored = localStorage.getItem("pfv-terminal-hidden");
        if (hiddenStored === "0" || hiddenStored === "1") {
          term.dataset.hidden = hiddenStored;
        }
        const maxStored = localStorage.getItem("pfv-terminal-max");
        if (maxStored === "0" || maxStored === "1") {
          term.dataset.max = maxStored;
        }
        const posStored = localStorage.getItem("pfv-terminal-pos");
        if (posStored) {
          try {
            const pos = JSON.parse(posStored);
            if (typeof pos.left === "number" && typeof pos.top === "number") {
              term.style.left = `${pos.left}px`;
              term.style.top = `${pos.top}px`;
              term.style.right = "auto";
              term.style.bottom = "auto";
            }
          } catch {}
        }
        const sizeStored = localStorage.getItem("pfv-terminal-size");
        if (sizeStored) {
          try {
            const size = JSON.parse(sizeStored);
            if (typeof size.width === "number" && typeof size.height === "number") {
              term.style.width = `${size.width}px`;
              term.style.height = `${size.height}px`;
            }
          } catch {}
        }

        function syncTerminalUi() {
          toggleBtn.textContent = term.dataset.open === "1" ? "Hide" : "Show";
          term.dataset.min = term.dataset.open === "1" ? "0" : "1";
          const hidden = term.dataset.hidden === "1";
          fab.hidden = !hidden;
          tab.textContent = hidden ? "Show Terminal" : "Hide Terminal";
        }

        syncTerminalUi();

        toggleBtn.addEventListener("click", () => {
          const next = term.dataset.open === "1" ? "0" : "1";
          term.dataset.open = next;
          localStorage.setItem("pfv-terminal-open", next);
          syncTerminalUi();
        });

        clearBtn.addEventListener("click", () => {
          body.innerHTML = "";
        });

        closeDot.addEventListener("click", () => {
          term.dataset.hidden = "1";
          localStorage.setItem("pfv-terminal-hidden", "1");
          syncTerminalUi();
        });

        fab.addEventListener("click", () => {
          term.dataset.hidden = "0";
          term.dataset.open = "1";
          localStorage.setItem("pfv-terminal-hidden", "0");
          localStorage.setItem("pfv-terminal-open", "1");
          syncTerminalUi();
        });

        tab.addEventListener("click", () => {
          const hidden = term.dataset.hidden === "1";
          term.dataset.hidden = hidden ? "0" : "1";
          term.dataset.open = hidden ? "1" : term.dataset.open;
          localStorage.setItem("pfv-terminal-hidden", term.dataset.hidden);
          localStorage.setItem("pfv-terminal-open", term.dataset.open);
          syncTerminalUi();
        });

        minDot.addEventListener("click", () => {
          if (term.dataset.max === "1") {
            term.dataset.max = "0";
            localStorage.setItem("pfv-terminal-max", "0");
            const premax = localStorage.getItem("pfv-terminal-premax");
            if (premax) {
              try {
                const pos = JSON.parse(premax);
                if (typeof pos.left === "number") term.style.left = `${pos.left}px`;
                if (typeof pos.top === "number") term.style.top = `${pos.top}px`;
                if (typeof pos.width === "number") term.style.width = `${pos.width}px`;
                if (typeof pos.height === "number") term.style.height = `${pos.height}px`;
                term.style.right = "auto";
                term.style.bottom = "auto";
              } catch {}
            }
          }
          const next = term.dataset.open === "1" ? "0" : "1";
          term.dataset.open = next;
          term.dataset.min = next === "1" ? "0" : "1";
          if (next === "1") {
            const sizeStored = localStorage.getItem("pfv-terminal-size");
            if (sizeStored) {
              try {
                const size = JSON.parse(sizeStored);
                if (typeof size.width === "number") term.style.width = `${size.width}px`;
                if (typeof size.height === "number") term.style.height = `${size.height}px`;
              } catch {}
            }
          } else {
            term.style.height = "";
          }
          localStorage.setItem("pfv-terminal-open", next);
          syncTerminalUi();
        });

        maxDot.addEventListener("click", () => {
          const next = term.dataset.max === "1" ? "0" : "1";
          if (next === "1") {
            const rect = term.getBoundingClientRect();
            localStorage.setItem(
              "pfv-terminal-premax",
              JSON.stringify({
                left: rect.left,
                top: rect.top,
                width: rect.width,
                height: rect.height,
              })
            );
          }
          term.dataset.max = next;
          localStorage.setItem("pfv-terminal-max", next);
          if (term.dataset.open !== "1") {
            term.dataset.open = "1";
            localStorage.setItem("pfv-terminal-open", "1");
          }
          if (next === "1") {
            term.style.left = "";
            term.style.top = "";
            term.style.right = "";
            term.style.bottom = "";
            term.style.width = "";
            term.style.height = "";
          } else {
            const premax = localStorage.getItem("pfv-terminal-premax");
            if (premax) {
              try {
                const pos = JSON.parse(premax);
                if (typeof pos.left === "number") term.style.left = `${pos.left}px`;
                if (typeof pos.top === "number") term.style.top = `${pos.top}px`;
                if (typeof pos.width === "number") term.style.width = `${pos.width}px`;
                if (typeof pos.height === "number") term.style.height = `${pos.height}px`;
                term.style.right = "auto";
                term.style.bottom = "auto";
              } catch {}
            }
          }
          syncTerminalUi();
        });

        let autoScroll = true;
        body.addEventListener("scroll", () => {
          autoScroll = body.scrollTop + body.clientHeight >= body.scrollHeight - 8;
        });

        function fmtTs(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour12: false });
          } catch {
            return iso;
          }
        }

        function fmtDate(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleDateString([], { year: "numeric", month: "short", day: "2-digit" });
          } catch {
            return "";
          }
        }

        let lastDateLabel = "";

        function appendEvent(evt) {
          const dateLabel = fmtDate(evt.ts || new Date().toISOString());
          if (dateLabel && dateLabel !== lastDateLabel) {
            const divider = document.createElement("div");
            divider.className = "terminal-line terminal-date";
            divider.textContent = dateLabel;
            body.appendChild(divider);
            lastDateLabel = dateLabel;
          }

          const line = document.createElement("div");
          line.className = `terminal-line level-${(evt.level || "INFO").toLowerCase()}`;

          const ts = document.createElement("span");
          ts.className = "terminal-ts";
          ts.textContent = `[${fmtTs(evt.ts || new Date().toISOString())}]`;

          const action = document.createElement("span");
          action.className = "terminal-action";
          action.textContent = `${evt.action || "system"}:`;

          const msg = document.createElement("span");
          msg.className = "terminal-msg";
          msg.textContent = evt.message || "";

          line.append(ts, action, msg);
          body.appendChild(line);

          if (autoScroll) {
            body.scrollTop = body.scrollHeight;
          }
        }

        termForm?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const raw = termCommand?.value || "";
          if (!raw.trim()) return;
          appendEvent({ level: "INFO", action: "cmd", message: raw });
          if (termCommand) termCommand.value = "";
          try {
            const res = await fetch("/ui/terminal", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ command: raw }),
            });
            const data = await res.json();
            if (!res.ok) {
              appendEvent({ level: "ERROR", action: "cmd", message: data.detail || "Command failed" });
            } else {
              appendEvent({ level: "SUCCESS", action: "cmd", message: data.message || "OK" });
            }
          } catch {
            appendEvent({ level: "ERROR", action: "cmd", message: "Terminal command failed to send." });
          }
        });

        termCommand?.addEventListener("keydown", async (e) => {
          if (e.key !== "Tab") return;
          e.preventDefault();
          const value = termCommand.value;
          const parts = value.split(/\s+/);
          if (parts.length === 0) return;
          const current = parts[parts.length - 1] || "";
          try {
            const res = await fetch(`/ui/terminal/suggest?prefix=${encodeURIComponent(current)}`, {
              cache: "no-store",
              credentials: "same-origin",
            });
            const data = await res.json();
            const suggestions = data.suggestions || [];
            if (suggestions.length === 1) {
              parts[parts.length - 1] = suggestions[0];
              termCommand.value = parts.join(" ") + (suggestions[0].endsWith("/") ? "" : " ");
            } else if (suggestions.length > 1) {
              appendEvent({
                level: "INFO",
                action: "suggest",
                message: suggestions.join("  "),
              });
            }
          } catch {
            appendEvent({ level: "ERROR", action: "suggest", message: "Autocomplete failed." });
          }
        });

        let afterId = Number(sessionStorage.getItem("pfv-terminal-after") || 0);
        let signInNotified = false;

        async function poll(url) {
          try {
            const res = await fetch(url, {
              credentials: "same-origin",
              headers: { Accept: "application/json" },
              cache: "no-store",
            });
            if (!res.ok) {
              if (res.status === 401) {
                if (!signInNotified) {
                  signInNotified = true;
                  appendEvent({ level: "INFO", action: "system", message: "Sign in to see activity." });
                }
              }
              return;
            }
            const data = await res.json();
            const events = data.events || [];
            for (const evt of events) appendEvent(evt);
            if (events.length) {
              afterId = events[events.length - 1].id;
              sessionStorage.setItem("pfv-terminal-after", String(afterId));
            }
            if (signInNotified) {
              signInNotified = false;
            }
          } catch {
            // Ignore transient network errors in the UI terminal.
          }
        }

        // Theme sync for terminal
        function syncTerminalTheme() {
          term.dataset.theme = document.body.dataset.theme || "light";
        }
        syncTerminalTheme();
        const themeObserver = new MutationObserver(syncTerminalTheme);
        themeObserver.observe(document.body, { attributes: true, attributeFilter: ["data-theme"] });

        // Drag support (disabled when maximized)
        let dragActive = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let originLeft = 0;
        let originTop = 0;

        function onDragStart(e) {
          if (term.dataset.max === "1") return;
          const target = e.target;
          if (target.closest(".terminal-actions")) return;
          dragActive = true;
          const rect = term.getBoundingClientRect();
          originLeft = rect.left;
          originTop = rect.top;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          term.classList.add("dragging");
          document.addEventListener("mousemove", onDragMove);
          document.addEventListener("mouseup", onDragEnd);
        }

        function onDragMove(e) {
          if (!dragActive) return;
          const dx = e.clientX - dragStartX;
          const dy = e.clientY - dragStartY;
          const left = Math.max(8, Math.min(window.innerWidth - 320, originLeft + dx));
          const top = Math.max(8, Math.min(window.innerHeight - 120, originTop + dy));
          term.style.left = `${left}px`;
          term.style.top = `${top}px`;
          term.style.right = "auto";
          term.style.bottom = "auto";
        }

        function onDragEnd() {
          dragActive = false;
          term.classList.remove("dragging");
          document.removeEventListener("mousemove", onDragMove);
          document.removeEventListener("mouseup", onDragEnd);
          const rect = term.getBoundingClientRect();
          localStorage.setItem("pfv-terminal-pos", JSON.stringify({ left: rect.left, top: rect.top }));
        }

        term.querySelector(".terminal-bar")?.addEventListener("mousedown", onDragStart);

        // Resize support (sides + top/bottom)
        const handles = term.querySelectorAll(".resize-handle");
        let resizeActive = false;
        let resizeDir = "";
        let startW = 0;
        let startH = 0;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;

        function onResizeStart(e) {
          if (term.dataset.max === "1") return;
          resizeActive = true;
          resizeDir = e.target.dataset.resize || "";
          const rect = term.getBoundingClientRect();
          startW = rect.width;
          startH = rect.height;
          startLeft = rect.left;
          startTop = rect.top;
          startX = e.clientX;
          startY = e.clientY;
          document.addEventListener("mousemove", onResizeMove);
          document.addEventListener("mouseup", onResizeEnd);
          e.preventDefault();
          e.stopPropagation();
        }

        function onResizeMove(e) {
          if (!resizeActive) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          let newW = startW;
          let newH = startH;
          let newLeft = startLeft;
          let newTop = startTop;

          if (resizeDir.includes("e")) {
            newW = Math.max(360, startW + dx);
          }
          if (resizeDir.includes("w")) {
            newW = Math.max(360, startW - dx);
            newLeft = startLeft + dx;
          }
          if (resizeDir.includes("s")) {
            newH = Math.max(180, startH + dy);
          }
          if (resizeDir.includes("n")) {
            newH = Math.max(180, startH - dy);
            newTop = startTop + dy;
          }

          term.style.width = `${newW}px`;
          term.style.height = `${newH}px`;
          term.style.left = `${newLeft}px`;
          term.style.top = `${newTop}px`;
          term.style.right = "auto";
          term.style.bottom = "auto";
        }

        function onResizeEnd() {
          resizeActive = false;
          document.removeEventListener("mousemove", onResizeMove);
          document.removeEventListener("mouseup", onResizeEnd);
          const rect = term.getBoundingClientRect();
          localStorage.setItem(
            "pfv-terminal-pos",
            JSON.stringify({ left: rect.left, top: rect.top })
          );
          localStorage.setItem(
            "pfv-terminal-size",
            JSON.stringify({ width: rect.width, height: rect.height })
          );
        }

        handles.forEach((h) => h.addEventListener("mousedown", onResizeStart));

        async function bootstrapActivity() {
          try {
            const res = await fetch("/ui/activity?no_history=1&redact=1", {
              credentials: "same-origin",
              headers: { Accept: "application/json" },
              cache: "no-store",
            });
            if (res.ok) {
              const data = await res.json();
              afterId = Number(data.last_id || 0);
              sessionStorage.setItem("pfv-terminal-after", String(afterId));
            }
          } catch {
            // Ignore bootstrap errors.
          }
        }

        bootstrapActivity().finally(() => {
          setInterval(() => {
            poll(`/ui/activity?after_id=${afterId}&limit=200&redact=1`);
          }, 1000);
        });
      })();
    </script>
  </body>
</html>
