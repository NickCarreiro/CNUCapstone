<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "FileFort" }}</title>
    <script>
      (function () {
        const key = "pfv-theme";
        let initialTheme = "light";
        try {
          const stored = localStorage.getItem(key);
          if (stored === "dark" || stored === "light") {
            initialTheme = stored;
          } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
            initialTheme = "dark";
          }
        } catch {
          if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
            initialTheme = "dark";
          }
        }
        document.documentElement.setAttribute("data-theme", initialTheme);
      })();
    </script>
    <script>
      (function () {
        const key = "pfv_timezone";
        let detected = "";
        try {
          detected = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
        } catch {
          detected = "";
        }
        if (!detected) return;
        try {
          document.cookie = `${key}=${detected}; Max-Age=31536000; Path=/; SameSite=Lax`;
        } catch {}
        window.__pfvDetectedTimezone = detected;
      })();
    </script>
    <script>
      (function () {
        const root = document.documentElement;
        root.classList.add("vp-pending");

        function applyViewportMetrics() {
          const vv = window.visualViewport;
          const width = Math.max(Math.round(vv ? vv.width : window.innerWidth || 0), 320);
          const height = Math.max(Math.round(vv ? vv.height : window.innerHeight || 0), 320);
          root.style.setProperty("--app-vw", `${width}px`);
          root.style.setProperty("--app-vh", `${height}px`);

          const header = document.querySelector(".site-header");
          const footer = document.querySelector(".site-footer");
          const headerHeight = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
          const footerHeight = footer ? Math.ceil(footer.getBoundingClientRect().height) : 0;
          root.style.setProperty("--app-header-h", `${headerHeight}px`);
          root.style.setProperty("--app-footer-h", `${footerHeight}px`);
        }

        function markReady() {
          root.classList.remove("vp-pending");
          root.classList.add("vp-ready");
        }

        function bootstrapViewport() {
          applyViewportMetrics();
          markReady();
        }

        applyViewportMetrics();
        if (!window.matchMedia("(max-width: 760px)").matches) {
          markReady();
        }

        if (document.readyState === "loading") {
          document.addEventListener(
            "DOMContentLoaded",
            () => {
              requestAnimationFrame(bootstrapViewport);
            },
            { once: true }
          );
        } else {
          requestAnimationFrame(bootstrapViewport);
        }

        window.addEventListener("resize", applyViewportMetrics, { passive: true });
        window.addEventListener(
          "orientationchange",
          () => {
            requestAnimationFrame(applyViewportMetrics);
          },
          { passive: true }
        );

        if (window.visualViewport) {
          window.visualViewport.addEventListener("resize", applyViewportMetrics, { passive: true });
        }
      })();
    </script>
    <style>
      html,
      body {
        min-height: 100%;
        height: 100%;
        margin: 0;
      }

      html[data-theme="dark"] {
        background: #050913;
      }

      html[data-theme="light"] {
        background: #f6f7fb;
      }

      html[data-theme="dark"] body {
        background: #050913;
        color: #ebf2ff;
      }

      html[data-theme="light"] body {
        background: #f6f7fb;
        color: #0b1020;
      }

      body[data-ui="future"] .nav-icon svg,
      body[data-ui="future"] .file-type-logo svg {
        width: 1rem;
        height: 1rem;
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      body[data-ui="future"][data-view-mode="base"]::before,
      body[data-ui="future"][data-view-mode="base"]::after {
        opacity: 0.4;
        filter: none;
      }

      body[data-ui="future"][data-view-mode="base"] .site-header {
        backdrop-filter: none;
      }

      body[data-ui="future"][data-view-mode="base"] .nav-group,
      body[data-ui="future"][data-view-mode="base"] .card,
      body[data-ui="future"][data-view-mode="base"] .profile-pill {
        box-shadow: none;
      }

      body[data-ui="future"][data-view-mode="base"] .hero-card::before {
        display: none;
      }

      body[data-ui="future"][data-view-mode="base"] .content > * {
        animation: none;
      }

      @media (max-width: 760px) {
        html.vp-pending body {
          opacity: 0;
          pointer-events: none;
        }

        html.vp-ready body {
          opacity: 1;
          pointer-events: auto;
        }
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700&family=IBM+Plex+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700&family=IBM+Plex+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      />
    </noscript>
    <link rel="preload" href="/static/style.css?v=29" as="style" />
    <link rel="preload" href="/static/future.css?v=23" as="style" />
    <link rel="stylesheet" href="/static/style.css?v=29" />
    <link rel="stylesheet" href="/static/future.css?v=23" />
    {% if user %}
    <link rel="prefetch" href="/ui" />
    <link rel="prefetch" href="/ui/groups" />
    <link rel="prefetch" href="/ui/messages" />
    <link rel="prefetch" href="/ui/help" />
    {% if user.is_admin %}
    <link rel="prefetch" href="/ui/admin/security" />
    <link rel="prefetch" href="/ui/admin/reports" />
    {% endif %}
    {% endif %}
  </head>
  {% set _cookie_theme = request.cookies.get("pfv-theme") if request else None %}
  {% set _initial_theme = _cookie_theme if _cookie_theme in ["light", "dark"] else "light" %}
  {% set _cookie_timezone = request.cookies.get("pfv_timezone") if request else None %}
  {% set _user_timezone = user.timezone if user and user.timezone else "" %}
  {% set _effective_timezone = _user_timezone if _user_timezone else (_cookie_timezone if _cookie_timezone else "UTC") %}
  {% set _ui_raw_mode = user.ui_view_mode if user and user.ui_view_mode else "base" %}
  {% set _ui_view_mode = "advanced" if _ui_raw_mode|trim|lower == "advanced" else "base" %}
  {% set _is_advanced_view = _ui_view_mode == "advanced" %}
  <body
    data-ui="future"
    data-view-mode="{{ _ui_view_mode }}"
    data-theme="{{ _initial_theme }}"
    data-timezone="{{ _effective_timezone }}"
    data-timezone-user="{{ _user_timezone }}"
    class="{% block body_class %}{% endblock %}{% if user %} has-user-menu{% endif %}"
  >
    <div class="page">
      <header class="site-header">
        <div class="container header-inner">
          <div class="brand-group">
            <div class="brand">FileFort</div>
            <div class="brand-sub">Single-host secure storage</div>
          </div>
          <div class="toolbar">
            {% if user %}
            {% set _path = request.url.path if request else "" %}
            {% set _workspace_open = _path.startswith("/ui/help") or _path == "/ui/trash" or (_is_advanced_view and _path == "/ui/audit") %}
            {% set _admin_open = _path.startswith("/ui/admin") %}
            <nav class="nav" id="pfvPrimaryNav">
              <section class="nav-group nav-group-user">
                <div class="nav-group-title">User</div>
                {% if _is_advanced_view %}
                <button type="button" class="nav-pill" id="pfvTerminalNav">
                  <span class="nav-link-main">
                    <span class="nav-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24">
                        <rect x="3" y="5" width="18" height="14" rx="2"></rect>
                        <path d="M7.5 10l2.5 2-2.5 2"></path>
                        <path d="M11.5 14h4.5"></path>
                      </svg>
                    </span>
                    <span>Terminal</span>
                  </span>
                  <span class="nav-link-tail" aria-hidden="true">&rsaquo;</span>
                </button>
                {% endif %}
                <a href="/ui" {% if _path == "/ui" %}aria-current="page"{% endif %}>
                  <span class="nav-link-main">
                    <span class="nav-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="8" height="8" rx="1.5"></rect>
                        <rect x="13" y="3" width="8" height="5" rx="1.5"></rect>
                        <rect x="13" y="10" width="8" height="11" rx="1.5"></rect>
                        <rect x="3" y="13" width="8" height="8" rx="1.5"></rect>
                      </svg>
                    </span>
                    <span>Storage</span>
                  </span>
                </a>
	                <a
	                  href="/ui/groups"
	                  class="nav-link-with-badge"
	                  id="pfvNavGroupsLink"
	                  {% if _path.startswith("/ui/groups") %}aria-current="page"{% endif %}
	                >
	                  <span class="nav-link-main">
	                    <span class="nav-icon" aria-hidden="true">
	                      <svg viewBox="0 0 24 24">
	                        <circle cx="8" cy="8" r="2.5"></circle>
	                        <circle cx="16.5" cy="9.5" r="2.2"></circle>
	                        <path d="M4.2 17c.7-2.2 2.4-3.3 4.8-3.3s4.1 1.1 4.8 3.3"></path>
	                        <path d="M13.1 16.7c.5-1.6 1.8-2.4 3.6-2.4 1.3 0 2.4.4 3.1 1.3"></path>
	                      </svg>
	                    </span>
	                    <span>Groups</span>
	                  </span>
	                  <span class="nav-count" id="pfvNavBadgeGroups" hidden>0</span>
	                </a>
	                <a
	                  href="/ui/messages"
	                  class="nav-link-with-badge"
	                  id="pfvNavMessagesLink"
	                  {% if _path.startswith("/ui/messages") %}aria-current="page"{% endif %}
	                >
	                  <span class="nav-link-main">
	                    <span class="nav-icon" aria-hidden="true">
	                      <svg viewBox="0 0 24 24">
	                        <rect x="3" y="5" width="18" height="14" rx="2"></rect>
	                        <path d="M4.5 7l7.5 6 7.5-6"></path>
	                      </svg>
	                    </span>
	                    <span>Messages</span>
	                  </span>
	                  <span class="nav-count" id="pfvNavBadgeMessages" hidden>0</span>
	                </a>

                <details class="nav-section" {% if _workspace_open %}open{% endif %}>
                  <summary>
                    <span class="nav-link-main">
                      <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24">
                          <path d="M3 9.5a2 2 0 0 1 2-2h5l1.5 2h7.5a2 2 0 0 1 2 2V17a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        </svg>
                      </span>
                      <span>Workspace</span>
                    </span>
                  </summary>
                  <div class="nav-section-links">
                    <a href="/ui/help" {% if _path.startswith("/ui/help") %}aria-current="page"{% endif %}>
                      <span class="nav-link-main">
                        <span class="nav-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="8.5"></circle>
                            <path d="M9.8 9.7a2.4 2.4 0 1 1 4 1.8c-.9.6-1.3 1-1.3 2.1"></path>
                            <circle cx="12" cy="16.8" r=".7" fill="currentColor" stroke="none"></circle>
                          </svg>
                        </span>
                        <span>Help</span>
                      </span>
                    </a>
                    {% if _is_advanced_view %}
	                  <a href="/ui/audit" {% if _path == "/ui/audit" %}aria-current="page"{% endif %}>
	                    <span class="nav-link-main">
	                      <span class="nav-icon" aria-hidden="true">
	                        <svg viewBox="0 0 24 24">
	                          <path d="M9 3h6l2 2h2a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h2z"></path>
	                          <path d="M8 12l2.2 2.2L16 8.5"></path>
	                        </svg>
	                      </span>
	                      <span>Audit</span>
	                    </span>
	                  </a>
                    {% endif %}
	                  <a href="/ui/trash" {% if _path == "/ui/trash" %}aria-current="page"{% endif %}>
	                    <span class="nav-link-main">
	                      <span class="nav-icon" aria-hidden="true">
	                        <svg viewBox="0 0 24 24">
	                          <path d="M4.5 7h15"></path>
	                          <path d="M9 7V5.8A1.8 1.8 0 0 1 10.8 4h2.4A1.8 1.8 0 0 1 15 5.8V7"></path>
	                          <path d="M7 7l1 12h8l1-12"></path>
	                        </svg>
	                      </span>
	                      <span>Trash</span>
	                    </span>
	                  </a>
                  </div>
                </details>
              </section>

              {% if user.is_admin %}
              <section class="nav-group nav-group-admin">
                <div class="nav-group-title">Admin</div>
                <details class="nav-section" {% if _admin_open %}open{% endif %}>
                  <summary>
                    <span class="nav-link-main">
                      <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24">
                          <path d="M12 3l7 3.5v5.2c0 4.4-2.7 7.8-7 9.3-4.3-1.5-7-4.9-7-9.3V6.5z"></path>
                          <path d="M9.5 12.5l1.5 1.5 3.5-3.5"></path>
                        </svg>
                      </span>
                      <span>Administration</span>
                    </span>
                  </summary>
                  <div class="nav-section-links">
                    <a href="/ui/admin/security" {% if _path.startswith("/ui/admin/security") %}aria-current="page"{% endif %}>
                      <span class="nav-link-main">
                        <span class="nav-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <path d="M12 3l7 3.5v5.2c0 4.4-2.7 7.8-7 9.3-4.3-1.5-7-4.9-7-9.3V6.5z"></path>
                            <path d="M12 8v4"></path>
                            <circle cx="12" cy="15.8" r=".8" fill="currentColor" stroke="none"></circle>
                          </svg>
                        </span>
                        <span>Security</span>
                      </span>
                    </a>
                    <a href="/ui/admin/help" {% if _path.startswith("/ui/admin/help") %}aria-current="page"{% endif %}>
                      <span class="nav-link-main">
                        <span class="nav-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <path d="M4 7.5h16"></path>
                            <path d="M5 5h14a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1z"></path>
                            <path d="M8 11h8"></path>
                          </svg>
                        </span>
                        <span>Help Inbox</span>
                      </span>
                    </a>
                    <a href="/ui/admin/reports" {% if _path.startswith("/ui/admin/reports") %}aria-current="page"{% endif %}>
                      <span class="nav-link-main">
                        <span class="nav-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <path d="M5 18V6"></path>
                            <path d="M9 18V10"></path>
                            <path d="M13 18V8"></path>
                            <path d="M17 18V12"></path>
                          </svg>
                        </span>
                        <span>Reports</span>
                      </span>
                    </a>
                    {% if _is_advanced_view %}
                    <a href="/ui/admin/audit" {% if _path == "/ui/admin/audit" %}aria-current="page"{% endif %}>
                      <span class="nav-link-main">
                        <span class="nav-icon" aria-hidden="true">
                          <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="6"></circle>
                            <path d="M16 16l4 4"></path>
                          </svg>
                        </span>
                        <span>Admin Audit</span>
                      </span>
                    </a>
                    {% endif %}
                  </div>
                </details>
              </section>
              {% endif %}
            </nav>
            <div class="toolbar-actions">
              <button type="button" class="ghost nav-menu-toggle" id="pfvMenuToggle" aria-expanded="false" aria-controls="pfvPrimaryNav">Menu</button>
            </div>
            {% else %}
            <div class="toolbar-actions">
              <button type="button" class="ghost toggle-theme" id="themeToggle">Dark mode</button>
            </div>
            {% endif %}
          </div>
        </div>
      </header>
      <main class="content container">
        {% block content %}{% endblock %}
      </main>
      <footer class="site-footer">
        <div class="container footer-inner">Single-host secure storage</div>
      </footer>
    </div>
    {% if user %}
    <div class="profile-wrap">
      <button
        type="button"
        class="profile-pill"
        id="pfvProfileBtn"
        aria-expanded="false"
        aria-controls="pfvProfileMenu"
      >
        <span class="profile-avatar" aria-hidden="true">
          {% if user.profile_image_path %}
          <img src="/ui/profile/avatar" alt="" class="profile-avatar-img" loading="lazy" decoding="async" />
          {% else %}
          {{ user.username[:1]|upper }}
          {% endif %}
        </span>
        <span class="profile-meta">
          <span class="profile-name">{{ user.username }}</span>
          <span class="profile-sub">Signed in</span>
        </span>
      </button>
      <div class="profile-menu" id="pfvProfileMenu" hidden>
        <div class="profile-menu-head">
          Signed in as {{ user.username }}
          {% if user.email and user.email_visible and user.email_verified %}
          <br /><span class="profile-menu-subtle">{{ user.email }}</span>
          {% endif %}
        </div>
        <a class="profile-menu-item" href="/ui/profile">Profile</a>
        <a class="profile-menu-item" href="/ui/mfa">MFA</a>
        <button type="button" class="profile-menu-item" id="themeToggle">Dark mode</button>
        <a class="profile-menu-item danger" href="/ui/logout">Logout</a>
      </div>
    </div>
    {% endif %}
	    {% block scripts %}{% endblock %}
		    <script>
		      const root = document.body;
		      const toggle = document.getElementById("themeToggle");
		      const BG_STORAGE_KEY = "pfv-custom-bg";
		      const THEME_STORAGE_KEY = "pfv-theme";
		      const COLOR_STORAGE_KEY = "pfv-custom-colors";
		      const TIMEZONE_STORAGE_COOKIE = "pfv_timezone";

      function writeTimezoneCookie(value) {
        const normalized = String(value || "").trim();
        if (!normalized) return;
        try {
          document.cookie = `${TIMEZONE_STORAGE_COOKIE}=${normalized}; Max-Age=31536000; Path=/; SameSite=Lax`;
        } catch {}
      }

      const timezoneOverride = (root?.dataset?.timezoneUser || "").trim();
      const detectedTimezone = (window.__pfvDetectedTimezone || "").trim();
      const serverTimezone = (root?.dataset?.timezone || "").trim();
      if (detectedTimezone) {
        writeTimezoneCookie(detectedTimezone);
      }
      const effectiveTimezone = timezoneOverride || detectedTimezone || (root?.dataset?.timezone || "UTC");
      if (root) {
        root.dataset.timezone = effectiveTimezone;
      }
      window.__pfvTimezone = effectiveTimezone;
      if (!timezoneOverride && detectedTimezone && serverTimezone && serverTimezone !== detectedTimezone) {
        const syncFlag = "pfv-timezone-sync-once";
        try {
          if (sessionStorage.getItem(syncFlag) !== "1") {
            sessionStorage.setItem(syncFlag, "1");
            window.location.reload();
          }
        } catch {}
      } else {
        try {
          sessionStorage.removeItem("pfv-timezone-sync-once");
        } catch {}
      }

      function readStorage(key) {
        try {
          return localStorage.getItem(key);
        } catch {
          return null;
        }
      }

      function writeStorage(key, value) {
        try {
          if (value === null || value === undefined || value === "") {
            localStorage.removeItem(key);
          } else {
            localStorage.setItem(key, value);
          }
        } catch {}
      }

      function normalizeHex(value, fallback) {
        const raw = String(value || "").trim();
        return /^#[0-9a-fA-F]{6}$/.test(raw) ? raw.toLowerCase() : fallback;
      }

      function toRgb(hex) {
        const value = normalizeHex(hex, "#00c7ff").slice(1);
        return {
          r: parseInt(value.slice(0, 2), 16),
          g: parseInt(value.slice(2, 4), 16),
          b: parseInt(value.slice(4, 6), 16),
        };
      }

      function shadeHex(hex, factor) {
        const rgb = toRgb(hex);
        const f = Math.max(0, Math.min(1, Number(factor || 0)));
        const clamp = (v) => Math.max(0, Math.min(255, Math.round(v)));
        const r = clamp(rgb.r * (1 - f));
        const g = clamp(rgb.g * (1 - f));
        const b = clamp(rgb.b * (1 - f));
        return `#${r.toString(16).padStart(2, "0")}${g.toString(16).padStart(2, "0")}${b.toString(16).padStart(2, "0")}`;
      }

      function writeThemeCookie(value) {
        try {
          const normalized = value === "dark" ? "dark" : "light";
          document.cookie = `pfv-theme=${normalized}; Max-Age=31536000; Path=/; SameSite=Lax`;
        } catch {}
      }

      function applyTheme(next) {
        const value = next === "dark" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", value);
        root.dataset.theme = value;
        writeThemeCookie(value);
        if (toggle) toggle.textContent = value === "dark" ? "Light mode" : "Dark mode";
      }

      function applyStoredTheme() {
        const stored = readStorage(THEME_STORAGE_KEY);
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(stored || (prefersDark ? "dark" : "light"));
      }

      function applyStoredBackground() {
        const bg = (readStorage(BG_STORAGE_KEY) || "").trim();
        if (bg) {
          root.style.setProperty("--pfv-custom-bg", bg);
        } else {
          root.style.removeProperty("--pfv-custom-bg");
        }
      }

      function applyStoredColors() {
        const raw = readStorage(COLOR_STORAGE_KEY) || "";
        if (!raw) {
          root.style.removeProperty("--accent");
          root.style.removeProperty("--accent-strong");
          root.style.removeProperty("--accent-2");
          root.style.removeProperty("--accent-2-soft");
          return;
        }
        try {
          const parsed = JSON.parse(raw);
          const accentA = normalizeHex(parsed.a, "#00c7ff");
          const accentB = normalizeHex(parsed.b, "#ffbf3c");
          root.style.setProperty("--accent", accentA);
          root.style.setProperty("--accent-strong", shadeHex(accentA, 0.2));
          root.style.setProperty("--accent-2", accentB);
          root.style.setProperty("--accent-2-soft", `${accentB}33`);
        } catch {
          writeStorage(COLOR_STORAGE_KEY, "");
          root.style.removeProperty("--accent");
          root.style.removeProperty("--accent-strong");
          root.style.removeProperty("--accent-2");
          root.style.removeProperty("--accent-2-soft");
        }
      }

      function syncTerminalTheme() {
        const term = document.getElementById("pfvTerminal");
        if (term) term.dataset.theme = root.dataset.theme === "dark" ? "dark" : "light";
      }

      applyStoredTheme();
      applyStoredBackground();
      applyStoredColors();

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", syncTerminalTheme, { once: true });
      } else {
        syncTerminalTheme();
      }

      if (toggle) {
        toggle.addEventListener("click", () => {
          const next = root.dataset.theme === "dark" ? "light" : "dark";
          applyTheme(next);
          writeStorage(THEME_STORAGE_KEY, next);
          syncTerminalTheme();
        });
      }

      if (window.matchMedia) {
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        const onThemeMediaChange = () => {
          if (readStorage(THEME_STORAGE_KEY)) return;
          applyTheme(mq.matches ? "dark" : "light");
          syncTerminalTheme();
        };
        if (typeof mq.addEventListener === "function") {
          mq.addEventListener("change", onThemeMediaChange);
        } else if (typeof mq.addListener === "function") {
          mq.addListener(onThemeMediaChange);
        }
      }

      window.PFVTheme = {
        applyTheme,
        applyStoredTheme,
        setThemePreference(value) {
          if (!value) {
            writeStorage(THEME_STORAGE_KEY, "");
            applyStoredTheme();
          } else {
            const next = value === "dark" ? "dark" : "light";
            writeStorage(THEME_STORAGE_KEY, next);
            applyTheme(next);
          }
          syncTerminalTheme();
        },
        setBackgroundCss(value) {
          writeStorage(BG_STORAGE_KEY, String(value || "").trim());
          applyStoredBackground();
        },
        setAccentColors(a, b) {
          const accentA = normalizeHex(a, "#00c7ff");
          const accentB = normalizeHex(b, "#ffbf3c");
          writeStorage(COLOR_STORAGE_KEY, JSON.stringify({ a: accentA, b: accentB }));
          applyStoredColors();
        },
        clearAccentColors() {
          writeStorage(COLOR_STORAGE_KEY, "");
          applyStoredColors();
        },
        getAccentColors() {
          const raw = readStorage(COLOR_STORAGE_KEY) || "";
          if (!raw) return null;
          try {
            const parsed = JSON.parse(raw);
            return { a: normalizeHex(parsed.a, "#00c7ff"), b: normalizeHex(parsed.b, "#ffbf3c") };
          } catch {
            return null;
          }
        },
      };

	      const toolbar = document.querySelector(".toolbar");
	      const nav = document.getElementById("pfvPrimaryNav");
      const menuToggle = document.getElementById("pfvMenuToggle");
      const mobileQuery = window.matchMedia("(max-width: 760px)");
      const MENU_STATE_KEY = "pfv-mobile-menu-open";

      function setMenuState(open) {
        if (!toolbar || !menuToggle) return;
        const isOpen = !!open;
        toolbar.dataset.menuOpen = isOpen ? "1" : "0";
        menuToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
        menuToggle.textContent = isOpen ? "Close menu" : "Menu";
      }

      function syncMenuState() {
        if (!toolbar || !menuToggle) return;
        if (!mobileQuery.matches) {
          toolbar.dataset.menuOpen = "1";
          menuToggle.setAttribute("aria-expanded", "false");
          menuToggle.textContent = "Menu";
          return;
        }
        const stored = localStorage.getItem(MENU_STATE_KEY);
        setMenuState(stored === "1");
      }

	      if (menuToggle && toolbar && nav) {
	        menuToggle.addEventListener("click", () => {
	          if (!mobileQuery.matches) return;
	          const nextOpen = toolbar.dataset.menuOpen !== "1";
	          setMenuState(nextOpen);
	          localStorage.setItem(MENU_STATE_KEY, nextOpen ? "1" : "0");
	        });

        nav.addEventListener("click", (event) => {
          const target = event.target instanceof Element ? event.target.closest("a, button") : null;
          if (!target || !mobileQuery.matches) return;
          setMenuState(false);
          localStorage.setItem(MENU_STATE_KEY, "0");
        });

        if (typeof mobileQuery.addEventListener === "function") {
          mobileQuery.addEventListener("change", syncMenuState);
        } else if (typeof mobileQuery.addListener === "function") {
          mobileQuery.addListener(syncMenuState);
        }

	        syncMenuState();
	      }
	
	      (function () {
	        const btn = document.getElementById("pfvProfileBtn");
	        const menu = document.getElementById("pfvProfileMenu");
	        if (!btn || !menu) return;
	
	        function setOpen(open) {
	          const isOpen = !!open;
	          btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
	          menu.hidden = !isOpen;
	        }
	
	        function close() {
	          setOpen(false);
	          document.removeEventListener("mousedown", onDocMouseDown, true);
	          document.removeEventListener("keydown", onDocKeyDown, true);
	        }
	
	        function onDocMouseDown(event) {
	          if (!(event.target instanceof Element)) return;
	          if (btn.contains(event.target) || menu.contains(event.target)) return;
	          close();
	        }
	
	        function onDocKeyDown(event) {
	          if (event.key === "Escape") close();
	        }
	
	        btn.addEventListener("click", () => {
	          const nextOpen = btn.getAttribute("aria-expanded") !== "true";
	          setOpen(nextOpen);
	          if (nextOpen) {
	            document.addEventListener("mousedown", onDocMouseDown, true);
	            document.addEventListener("keydown", onDocKeyDown, true);
	          } else {
	            close();
	          }
	        });
	
	        menu.addEventListener("click", (event) => {
	          const target = event.target instanceof Element ? event.target.closest("a, button") : null;
	          if (!target) return;
	          // Close on any selection to keep the header clean.
	          close();
	        });
	      })();

	      const navGroupsLink = document.getElementById("pfvNavGroupsLink");
	      const navGroupsBadge = document.getElementById("pfvNavBadgeGroups");
	      const navMessagesLink = document.getElementById("pfvNavMessagesLink");
	      const navMessagesBadge = document.getElementById("pfvNavBadgeMessages");
	      let notificationsTimer = null;

      async function refreshNotifications() {
        const hasGroups = !!(navGroupsBadge && navGroupsLink);
        const hasMessages = !!(navMessagesBadge && navMessagesLink);
        if (!hasGroups && !hasMessages) return;
        try {
          const response = await fetch("/ui/notifications", { credentials: "same-origin", cache: "no-store" });
          if (!response.ok) {
            if (response.status === 401) {
              if (navGroupsBadge) navGroupsBadge.hidden = true;
              if (navMessagesBadge) navMessagesBadge.hidden = true;
            }
            return;
          }
          const payload = await response.json();
          const unreadMessages = Number(payload.unread_messages || 0);
          const pendingInvites = Number(payload.pending_group_invites || 0);

          if (hasGroups) {
            navGroupsLink.title = `${pendingInvites} pending invites`;
            if (pendingInvites > 0) {
              navGroupsBadge.hidden = false;
              navGroupsBadge.textContent = pendingInvites > 99 ? "99+" : String(pendingInvites);
            } else {
              navGroupsBadge.hidden = true;
              navGroupsBadge.textContent = "0";
            }
          }

          if (hasMessages) {
            navMessagesLink.title = `${unreadMessages} unread messages`;
            if (unreadMessages > 0) {
              navMessagesBadge.hidden = false;
              navMessagesBadge.textContent = unreadMessages > 99 ? "99+" : String(unreadMessages);
            } else {
              navMessagesBadge.hidden = true;
              navMessagesBadge.textContent = "0";
            }
          }
        } catch {
          return;
        }
      }

      if ((navGroupsBadge && navGroupsLink) || (navMessagesBadge && navMessagesLink)) {
        refreshNotifications();
        notificationsTimer = window.setInterval(refreshNotifications, 15000);
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) refreshNotifications();
        });
        window.addEventListener(
          "beforeunload",
          () => {
            if (notificationsTimer) {
              clearInterval(notificationsTimer);
            }
          },
          { once: true }
        );
      }

      (function () {
        const prefetched = new Set();

        function prefetchPath(rawHref) {
          if (!rawHref) return;
          if (!rawHref.startsWith("/ui")) return;
          if (prefetched.has(rawHref)) return;
          prefetched.add(rawHref);
          const link = document.createElement("link");
          link.rel = "prefetch";
          link.href = rawHref;
          document.head.appendChild(link);
        }

        document.querySelectorAll("a[href^='/ui']").forEach((anchor) => {
          const href = anchor.getAttribute("href") || "";
          anchor.addEventListener("pointerenter", () => prefetchPath(href), { passive: true, once: true });
          anchor.addEventListener("focus", () => prefetchPath(href), { passive: true, once: true });
        });
      })();

      (function () {
        const COLLAPSE_PREFIX = "pfv-collapse:";

        function normalizeSelector(raw) {
          const value = (raw || "").trim();
          if (!value) return null;
          if (value.startsWith("#")) return value;
          if (value.startsWith(".")) return value;
          return `#${value}`;
        }

        function applyToggleState(toggleEl, collapsed) {
          toggleEl.dataset.collapsed = collapsed ? "1" : "0";
          toggleEl.setAttribute("aria-expanded", collapsed ? "false" : "true");

          const openLabel = toggleEl.dataset.collapseLabelOpen || "Hide filters";
          const closedLabel = toggleEl.dataset.collapseLabelClosed || "Show filters";
          toggleEl.textContent = collapsed ? closedLabel : openLabel;

          const visibleMode = (toggleEl.dataset.collapseVisible || "").trim().toLowerCase();
          if (visibleMode === "collapsed") {
            toggleEl.hidden = !collapsed;
          } else if (visibleMode === "expanded") {
            toggleEl.hidden = !!collapsed;
          } else {
            toggleEl.hidden = false;
          }
        }

        const groups = new Map();
        document.querySelectorAll("[data-collapse-target]").forEach((toggleEl) => {
          if (!(toggleEl instanceof HTMLElement)) return;
          const selector = normalizeSelector(toggleEl.dataset.collapseTarget);
          if (!selector) return;
          const targetEl = document.querySelector(selector);
          if (!(targetEl instanceof HTMLElement)) return;

          const storageKey = `${COLLAPSE_PREFIX}${location.pathname}:${selector}`;
          const existing = groups.get(storageKey);
          if (existing) {
            existing.toggles.push(toggleEl);
            return;
          }
          groups.set(storageKey, { storageKey, targetEl, toggles: [toggleEl] });
        });

        groups.forEach((group) => {
          const stored = localStorage.getItem(group.storageKey);
          const defaultCollapsed = group.toggles.some((t) => t.dataset.collapseDefault === "collapsed");
          let collapsed = stored === null ? defaultCollapsed : stored === "1";

          group.targetEl.hidden = !!collapsed;
          group.toggles.forEach((t) => applyToggleState(t, collapsed));

          group.toggles.forEach((toggleEl) => {
            toggleEl.addEventListener("click", () => {
              collapsed = !collapsed;
              localStorage.setItem(group.storageKey, collapsed ? "1" : "0");
              group.targetEl.hidden = !!collapsed;
              group.toggles.forEach((t) => applyToggleState(t, collapsed));
            });
          });
        });
      })();
    </script>

    {% if user and _is_advanced_view %}
    <div class="terminal" id="pfvTerminal" data-open="1" data-max="0" data-theme="dark" data-status="syncing">
      <div class="terminal-bar">
        <div class="terminal-left">
          <span class="terminal-badge">Live</span>
          <span class="terminal-title">Vault Activity Console</span>
        </div>
	        <div class="terminal-actions">
	          <button type="button" class="terminal-control" id="pfvTerminalMinimize" aria-label="Minimize terminal" title="Minimize">−</button>
	          <button type="button" class="terminal-control" id="pfvTerminalMaximize" aria-label="Maximize terminal" title="Maximize">▢</button>
	          <button type="button" class="terminal-control terminal-control-close" id="pfvTerminalClose" aria-label="Close terminal" title="Close">×</button>
	        </div>
	      </div>
      <div class="terminal-meta">
        <div class="terminal-metric"><span class="metric-key">Status</span><span class="metric-value" id="pfvTerminalStatus">SYNCING</span></div>
        <div class="terminal-metric"><span class="metric-key">Events</span><span class="metric-value" id="pfvTerminalEventCount">0</span></div>
        <div class="terminal-metric"><span class="metric-key">Scroll</span><span class="metric-value" id="pfvTerminalScrollState">AUTO</span></div>
        <label class="terminal-metric terminal-metric-toggle" for="pfvTerminalEncTimeline">
          <span class="metric-key">Trace</span>
          <span class="terminal-checkline">
            <input type="checkbox" id="pfvTerminalEncTimeline" />
            <span class="metric-value">ENC TIMELINE</span>
          </span>
        </label>
      </div>
      <div class="terminal-body" id="pfvTerminalBody" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div class="terminal-shortcuts" id="pfvTerminalShortcuts">
        <button type="button" class="terminal-shortcut" data-cmd="help">help</button>
        <button type="button" class="terminal-shortcut" data-cmd="scope">scope</button>
        <button type="button" class="terminal-shortcut" data-cmd="groups">groups</button>
        <button type="button" class="terminal-shortcut" data-cmd="list">list</button>
        <button type="button" class="terminal-shortcut" data-cmd="tree">tree</button>
        <button type="button" class="terminal-shortcut" data-cmd="find">find</button>
        <button type="button" class="terminal-shortcut" data-cmd="stat">stat</button>
        <button type="button" class="terminal-shortcut" data-cmd="quota">quota</button>
        <button type="button" class="terminal-shortcut" data-cmd="encstatus">encstatus</button>
        <button type="button" class="terminal-shortcut" data-cmd="enctimeline">enctimeline</button>
        <button type="button" class="terminal-shortcut" data-cmd="encproof">encproof</button>
        <button type="button" class="terminal-shortcut" data-cmd="encrotate all">encrotate</button>
        <button type="button" class="terminal-shortcut" data-cmd="directory">directory</button>
      </div>
      <form class="terminal-input" id="pfvTerminalForm">
        <span class="terminal-prompt" aria-hidden="true">vault$</span>
	        <input type="text" id="pfvTerminalCommand" name="command" placeholder="Type: help, list, tree, find, stat, view, hash, quota, encstatus, enctimeline, encrotate all, clear" autocomplete="off" />
        <button type="submit">Execute</button>
      </form>
      <span class="resize-handle handle-e" data-resize="e"></span>
      <span class="resize-handle handle-w" data-resize="w"></span>
      <span class="resize-handle handle-n" data-resize="n"></span>
      <span class="resize-handle handle-s" data-resize="s"></span>
    </div>
    <script>
	      (function () {
	        const term = document.getElementById("pfvTerminal");
	        const body = document.getElementById("pfvTerminalBody");
	        const closeDot = document.getElementById("pfvTerminalClose");
	        const minDot = document.getElementById("pfvTerminalMinimize");
	        const maxDot = document.getElementById("pfvTerminalMaximize");
	        const navTab = document.getElementById("pfvTerminalNav");
	        const termForm = document.getElementById("pfvTerminalForm");
	        const termCommand = document.getElementById("pfvTerminalCommand");
        const terminalStatus = document.getElementById("pfvTerminalStatus");
	        const terminalEventCount = document.getElementById("pfvTerminalEventCount");
	        const terminalScrollState = document.getElementById("pfvTerminalScrollState");
	        const terminalEncTimelineToggle = document.getElementById("pfvTerminalEncTimeline");
	        const terminalShortcuts = document.querySelectorAll(".terminal-shortcut");
	        if (!term || !body || !closeDot || !minDot || !maxDot) return;
        const VIEW_MARGIN = 12;
        const DESKTOP_MIN_WIDTH = 360;
        const DESKTOP_MIN_HEIGHT = 220;
        const TERMINAL_BODY_MIN_HEIGHT = 64;
        const TERMINAL_LAYOUT_VERSION = "3";
        const TERMINAL_ENC_TIMELINE_KEY = "pfv-terminal-enc-timeline";

        if (localStorage.getItem("pfv-terminal-layout-version") !== TERMINAL_LAYOUT_VERSION) {
          localStorage.removeItem("pfv-terminal-pos");
          localStorage.removeItem("pfv-terminal-size");
          localStorage.removeItem("pfv-terminal-max");
          localStorage.removeItem("pfv-terminal-premax");
          localStorage.setItem("pfv-terminal-layout-version", TERMINAL_LAYOUT_VERSION);
        }

        function pxToNumber(value) {
          if (typeof value !== "string" || !value) return null;
          const parsed = Number.parseFloat(value);
          return Number.isFinite(parsed) ? parsed : null;
        }

        function viewportBounds() {
          const vv = window.visualViewport;
          const width = Math.max((vv ? vv.width : window.innerWidth) || 0, 320);
          const height = Math.max((vv ? vv.height : window.innerHeight) || 0, 240);
          return {
            width,
            height,
            availableWidth: Math.max(220, width - VIEW_MARGIN * 2),
            availableHeight: Math.max(160, height - VIEW_MARGIN * 2),
          };
        }

        function minTerminalWidth(availableWidth) {
          return Math.min(DESKTOP_MIN_WIDTH, availableWidth);
        }

        function terminalChromeHeight() {
          if (term.dataset.open !== "1") return 0;
          const barHeight = term.querySelector(".terminal-bar")?.getBoundingClientRect().height || 0;
          const metaHeight = term.querySelector(".terminal-meta")?.getBoundingClientRect().height || 0;
          const shortcutsHeight = term.querySelector(".terminal-shortcuts")?.getBoundingClientRect().height || 0;
          const inputHeight = term.querySelector(".terminal-input")?.getBoundingClientRect().height || 0;
          return barHeight + metaHeight + shortcutsHeight + inputHeight;
        }

        function minTerminalHeight(availableHeight) {
          const dynamic = Math.ceil(terminalChromeHeight() + TERMINAL_BODY_MIN_HEIGHT);
          const preferred = Math.max(DESKTOP_MIN_HEIGHT, dynamic);
          return Math.min(preferred, availableHeight);
        }

        function persistTerminalFrame(rect = term.getBoundingClientRect()) {
          if (term.dataset.max === "1") return;
          localStorage.setItem(
            "pfv-terminal-pos",
            JSON.stringify({ left: Math.round(rect.left), top: Math.round(rect.top) })
          );
          localStorage.setItem(
            "pfv-terminal-size",
            JSON.stringify({ width: Math.round(rect.width), height: Math.round(rect.height) })
          );
        }

        function clampTerminalFrame({ persist = true } = {}) {
          if (term.dataset.max === "1") return;
          const { width: viewportWidth, height: viewportHeight, availableWidth, availableHeight } = viewportBounds();
          const minWidth = minTerminalWidth(availableWidth);
          const rect = term.getBoundingClientRect();

          let width = pxToNumber(term.style.width);
          let height = pxToNumber(term.style.height);
          if (width === null || width <= 0) {
            width = rect.width > 0 ? rect.width : availableWidth;
          }
          if (height === null || height <= 0) {
            height = rect.height > 0 ? rect.height : availableHeight;
          }

          width = Math.min(Math.max(width, minWidth), availableWidth);
          term.style.width = `${Math.round(width)}px`;
          const minHeight = minTerminalHeight(availableHeight);
          height = Math.min(Math.max(height, minHeight), availableHeight);

          let left = pxToNumber(term.style.left);
          let top = pxToNumber(term.style.top);
          if (left === null) {
            left = rect.width > 0 ? rect.left : viewportWidth - width - VIEW_MARGIN;
          }
          if (top === null) {
            top = rect.height > 0 ? rect.top : viewportHeight - height - VIEW_MARGIN;
          }

          const maxLeft = Math.max(VIEW_MARGIN, viewportWidth - width - VIEW_MARGIN);
          const maxTop = Math.max(VIEW_MARGIN, viewportHeight - height - VIEW_MARGIN);
          left = Math.min(Math.max(left, VIEW_MARGIN), maxLeft);
          top = Math.min(Math.max(top, VIEW_MARGIN), maxTop);

          term.style.width = `${Math.round(width)}px`;
          term.style.height = `${Math.round(height)}px`;
          term.style.left = `${Math.round(left)}px`;
          term.style.top = `${Math.round(top)}px`;
          term.style.right = "auto";
          term.style.bottom = "auto";
          if (persist) persistTerminalFrame();
        }

        const openStored = localStorage.getItem("pfv-terminal-open");
        if (openStored === "0" || openStored === "1") {
          term.dataset.open = openStored;
        } else if (window.matchMedia("(max-width: 760px)").matches) {
          term.dataset.open = "0";
          localStorage.setItem("pfv-terminal-open", "0");
        }
        term.dataset.min = term.dataset.open === "1" ? "0" : "1";
        const maxStored = localStorage.getItem("pfv-terminal-max");
        if (maxStored === "0" || maxStored === "1") {
          term.dataset.max = maxStored;
        }
        const posStored = localStorage.getItem("pfv-terminal-pos");
        if (posStored) {
          try {
            const pos = JSON.parse(posStored);
            if (typeof pos.left === "number" && typeof pos.top === "number") {
              term.style.left = `${pos.left}px`;
              term.style.top = `${pos.top}px`;
              term.style.right = "auto";
              term.style.bottom = "auto";
            }
          } catch {}
        }
        const sizeStored = localStorage.getItem("pfv-terminal-size");
        if (sizeStored) {
          try {
            const size = JSON.parse(sizeStored);
            if (typeof size.width === "number" && typeof size.height === "number") {
              term.style.width = `${size.width}px`;
              term.style.height = `${size.height}px`;
            }
          } catch {}
        }
        requestAnimationFrame(() => clampTerminalFrame({ persist: false }));

	        function syncTerminalUi() {
	          const isOpen = term.dataset.open === "1";
	          term.dataset.min = isOpen ? "0" : "1";
	          if (isOpen && term.dataset.max !== "1") {
	            requestAnimationFrame(() => clampTerminalFrame({ persist: false }));
	          }
	          if (navTab) {
	            navTab.textContent = isOpen ? "Hide Terminal" : "Terminal";
	          }
	        }

        syncTerminalUi();
        let renderedEvents = 0;
        function setStatus(value) {
          const normalized = (value || "LIVE").toUpperCase();
          if (terminalStatus) terminalStatus.textContent = normalized;
          term.dataset.status = normalized.toLowerCase();
        }

	        function clearTerminal() {
	          body.innerHTML = "";
	          renderedEvents = 0;
	          lastDateLabel = "";
	          if (terminalEventCount) terminalEventCount.textContent = "0";
	        }

        closeDot.addEventListener("click", () => {
          term.dataset.open = "0";
          localStorage.setItem("pfv-terminal-open", "0");
          syncTerminalUi();
        });

        navTab?.addEventListener("click", () => {
          const next = term.dataset.open === "1" ? "0" : "1";
          term.dataset.open = next;
          localStorage.setItem("pfv-terminal-open", next);
          syncTerminalUi();
        });

        minDot.addEventListener("click", () => {
          if (term.dataset.max === "1") {
            term.dataset.max = "0";
            localStorage.setItem("pfv-terminal-max", "0");
            const premax = localStorage.getItem("pfv-terminal-premax");
            if (premax) {
              try {
                const pos = JSON.parse(premax);
                if (typeof pos.left === "number") term.style.left = `${pos.left}px`;
                if (typeof pos.top === "number") term.style.top = `${pos.top}px`;
                if (typeof pos.width === "number") term.style.width = `${pos.width}px`;
                if (typeof pos.height === "number") term.style.height = `${pos.height}px`;
                term.style.right = "auto";
                term.style.bottom = "auto";
              } catch {}
            }
          }
          term.dataset.open = "0";
          term.dataset.min = "1";
          localStorage.setItem("pfv-terminal-open", "0");
          syncTerminalUi();
        });

        maxDot.addEventListener("click", () => {
          const next = term.dataset.max === "1" ? "0" : "1";
          if (next === "1") {
            const rect = term.getBoundingClientRect();
            localStorage.setItem(
              "pfv-terminal-premax",
              JSON.stringify({
                left: rect.left,
                top: rect.top,
                width: rect.width,
                height: rect.height,
              })
            );
          }
          term.dataset.max = next;
          localStorage.setItem("pfv-terminal-max", next);
          if (term.dataset.open !== "1") {
            term.dataset.open = "1";
            localStorage.setItem("pfv-terminal-open", "1");
          }
          if (next === "1") {
            term.style.left = "";
            term.style.top = "";
            term.style.right = "";
            term.style.bottom = "";
            term.style.width = "";
            term.style.height = "";
          } else {
            const premax = localStorage.getItem("pfv-terminal-premax");
            if (premax) {
              try {
                const pos = JSON.parse(premax);
                if (typeof pos.left === "number") term.style.left = `${pos.left}px`;
                if (typeof pos.top === "number") term.style.top = `${pos.top}px`;
                if (typeof pos.width === "number") term.style.width = `${pos.width}px`;
                if (typeof pos.height === "number") term.style.height = `${pos.height}px`;
                term.style.right = "auto";
                term.style.bottom = "auto";
              } catch {}
            }
          }
          syncTerminalUi();
        });

        let autoScroll = true;
        body.addEventListener("scroll", () => {
          autoScroll = body.scrollTop + body.clientHeight >= body.scrollHeight - 8;
          if (terminalScrollState) {
            terminalScrollState.textContent = autoScroll ? "AUTO" : "MANUAL";
          }
        });

        function fmtTs(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour12: false });
          } catch {
            return iso;
          }
        }

        function fmtDate(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleDateString([], { year: "numeric", month: "short", day: "2-digit" });
          } catch {
            return "";
          }
        }

        let lastDateLabel = "";

        function appendEvent(evt) {
          const dateLabel = fmtDate(evt.ts || new Date().toISOString());
          if (dateLabel && dateLabel !== lastDateLabel) {
            const divider = document.createElement("div");
            divider.className = "terminal-line terminal-date";
            divider.textContent = dateLabel;
            body.appendChild(divider);
            lastDateLabel = dateLabel;
          }

          const line = document.createElement("div");
          line.className = `terminal-line level-${(evt.level || "INFO").toLowerCase()}`;

          const ts = document.createElement("span");
          ts.className = "terminal-ts";
          ts.textContent = `[${fmtTs(evt.ts || new Date().toISOString())}]`;

          const action = document.createElement("span");
          action.className = "terminal-action";
          action.textContent = `${evt.action || "system"}:`;

          const msg = document.createElement("span");
          msg.className = "terminal-msg";
          msg.textContent = evt.message || "";

          line.append(ts, action, msg);
          body.appendChild(line);
          renderedEvents += 1;
          if (terminalEventCount) terminalEventCount.textContent = String(renderedEvents);

          if (autoScroll) {
            body.scrollTop = body.scrollHeight;
          }
        }

        async function runTerminalCommand(raw, options = {}) {
          const trimmed = String(raw || "").trim();
          if (!trimmed) return;

          const echoCommand = options.echoCommand !== false;
          const commandAction = options.commandAction || "cmd";
          const resultAction = options.resultAction || "cmd";
          const resultLevel = options.resultLevel || "SUCCESS";
          const clearInput = options.clearInput !== false;
          const pageContext = `${window.location.pathname}${window.location.search}`;

          if (trimmed.toLowerCase() === "clear") {
            clearTerminal();
            if (termCommand && clearInput) termCommand.value = "";
            setStatus("LIVE");
            return;
          }

          if (echoCommand) appendEvent({ level: "INFO", action: commandAction, message: raw });
          if (termCommand && clearInput) termCommand.value = "";
          setStatus("RUNNING");
          try {
            const res = await fetch("/ui/terminal", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ command: raw, page_context: pageContext }),
            });
            const data = await res.json();
            if (!res.ok) {
              appendEvent({ level: "ERROR", action: resultAction, message: data.detail || "Command failed" });
            } else {
              appendEvent({ level: resultLevel, action: resultAction, message: data.message || "OK" });
            }
            setStatus("LIVE");
          } catch {
            appendEvent({ level: "ERROR", action: resultAction, message: "Terminal command failed to send." });
            setStatus("OFFLINE");
          }
        }

        let encTimelineIntervalId = 0;
        let encTimelineBusy = false;

        async function runEncTimelineSnapshot({ announce = false } = {}) {
          if (!terminalEncTimelineToggle?.checked || encTimelineBusy) return;
          encTimelineBusy = true;
          if (announce) {
            appendEvent({ level: "INFO", action: "encwatch", message: "Encryption timeline enabled (auto refresh)." });
          }
          try {
            await runTerminalCommand("enctimeline", {
              echoCommand: false,
              resultAction: "encwatch",
              resultLevel: "INFO",
              clearInput: false,
            });
          } finally {
            encTimelineBusy = false;
          }
        }

        function stopEncTimelinePolling() {
          if (!encTimelineIntervalId) return;
          clearInterval(encTimelineIntervalId);
          encTimelineIntervalId = 0;
        }

        function setEncTimelineEnabled(enabled, { announce = true } = {}) {
          const next = !!enabled;
          if (terminalEncTimelineToggle) terminalEncTimelineToggle.checked = next;
          localStorage.setItem(TERMINAL_ENC_TIMELINE_KEY, next ? "1" : "0");
          stopEncTimelinePolling();
          if (!next) {
            if (announce) {
              appendEvent({ level: "INFO", action: "encwatch", message: "Encryption timeline disabled." });
            }
            return;
          }

          runEncTimelineSnapshot({ announce });
          encTimelineIntervalId = window.setInterval(() => {
            runEncTimelineSnapshot({ announce: false });
          }, 30000);
        }

        const encTimelineStored = localStorage.getItem(TERMINAL_ENC_TIMELINE_KEY);
        if (terminalEncTimelineToggle) {
          terminalEncTimelineToggle.checked = encTimelineStored === "1";
          terminalEncTimelineToggle.addEventListener("change", () => {
            setEncTimelineEnabled(terminalEncTimelineToggle.checked, { announce: true });
          });
          if (terminalEncTimelineToggle.checked) {
            setEncTimelineEnabled(true, { announce: false });
          }
        }

        window.addEventListener(
          "beforeunload",
          () => {
            stopEncTimelinePolling();
          },
          { once: true }
        );

	        termForm?.addEventListener("submit", async (e) => {
	          e.preventDefault();
	          const raw = termCommand?.value || "";
	          const trimmed = raw.trim();
	          if (!trimmed) return;
	          await runTerminalCommand(raw, {
	            echoCommand: true,
	            commandAction: "cmd",
	            resultAction: "cmd",
	            resultLevel: "SUCCESS",
	            clearInput: true,
	          });
	        });

        terminalShortcuts.forEach((shortcut) => {
          shortcut.addEventListener("click", () => {
            const cmd = shortcut.dataset.cmd || "";
            if (!termCommand) return;
            termCommand.value = cmd;
            termCommand.focus();
            termCommand.select();
          });
        });

        termCommand?.addEventListener("keydown", async (e) => {
          if (e.key !== "Tab") return;
          e.preventDefault();
          const value = termCommand.value;
          const parts = value.split(/\s+/);
          if (parts.length === 0) return;
          const current = parts[parts.length - 1] || "";
          try {
            const res = await fetch(`/ui/terminal/suggest?prefix=${encodeURIComponent(current)}`, {
              cache: "no-store",
              credentials: "same-origin",
            });
            const data = await res.json();
            const suggestions = data.suggestions || [];
            if (suggestions.length === 1) {
              parts[parts.length - 1] = suggestions[0];
              termCommand.value = parts.join(" ") + (suggestions[0].endsWith("/") ? "" : " ");
            } else if (suggestions.length > 1) {
              appendEvent({
                level: "INFO",
                action: "suggest",
                message: suggestions.join("  "),
              });
            }
          } catch {
            appendEvent({ level: "ERROR", action: "suggest", message: "Autocomplete failed." });
          }
        });

        let afterId = Number(sessionStorage.getItem("pfv-terminal-after") || 0);
        let signInNotified = false;

        async function poll(url) {
          try {
            const res = await fetch(url, {
              credentials: "same-origin",
              headers: { Accept: "application/json" },
              cache: "no-store",
            });
            if (!res.ok) {
              if (res.status === 401) {
                setStatus("AUTH");
                if (!signInNotified) {
                  signInNotified = true;
                  appendEvent({ level: "INFO", action: "system", message: "Sign in to see activity." });
                }
              }
              return;
            }
            setStatus("LIVE");
            const data = await res.json();
            const events = data.events || [];
            for (const evt of events) appendEvent(evt);
            if (events.length) {
              afterId = events[events.length - 1].id;
              sessionStorage.setItem("pfv-terminal-after", String(afterId));
            }
            if (signInNotified) {
              signInNotified = false;
            }
          } catch {
            // Ignore transient network errors in the UI terminal.
            setStatus("OFFLINE");
          }
        }

        // Theme sync for terminal
        function syncTerminalTheme() {
          term.dataset.theme = document.body.dataset.theme || "light";
        }
        syncTerminalTheme();
        const themeObserver = new MutationObserver(syncTerminalTheme);
        themeObserver.observe(document.body, { attributes: true, attributeFilter: ["data-theme"] });

        // Drag support (disabled when maximized)
        let dragActive = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let originLeft = 0;
        let originTop = 0;

        function onDragStart(e) {
          if (term.dataset.max === "1") return;
          const target = e.target;
          if (target.closest(".terminal-actions")) return;
          dragActive = true;
          const rect = term.getBoundingClientRect();
          originLeft = rect.left;
          originTop = rect.top;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          term.classList.add("dragging");
          document.addEventListener("mousemove", onDragMove);
          document.addEventListener("mouseup", onDragEnd);
        }

        function onDragMove(e) {
          if (!dragActive) return;
          const dx = e.clientX - dragStartX;
          const dy = e.clientY - dragStartY;
          const rect = term.getBoundingClientRect();
          const width = rect.width || minTerminalWidth(viewportBounds().availableWidth);
          const height = rect.height || minTerminalHeight(viewportBounds().availableHeight);
          const { width: viewportWidth, height: viewportHeight } = viewportBounds();
          const maxLeft = Math.max(VIEW_MARGIN, viewportWidth - width - VIEW_MARGIN);
          const maxTop = Math.max(VIEW_MARGIN, viewportHeight - height - VIEW_MARGIN);
          const left = Math.max(VIEW_MARGIN, Math.min(maxLeft, originLeft + dx));
          const top = Math.max(VIEW_MARGIN, Math.min(maxTop, originTop + dy));
          term.style.left = `${left}px`;
          term.style.top = `${top}px`;
          term.style.right = "auto";
          term.style.bottom = "auto";
        }

        function onDragEnd() {
          dragActive = false;
          term.classList.remove("dragging");
          document.removeEventListener("mousemove", onDragMove);
          document.removeEventListener("mouseup", onDragEnd);
          clampTerminalFrame({ persist: true });
        }

        term.querySelector(".terminal-bar")?.addEventListener("mousedown", onDragStart);

        // Resize support (sides + top/bottom)
        const handles = term.querySelectorAll(".resize-handle");
        let resizeActive = false;
        let resizeDir = "";
        let startW = 0;
        let startH = 0;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;

        function onResizeStart(e) {
          if (term.dataset.max === "1") return;
          resizeActive = true;
          resizeDir = e.target.dataset.resize || "";
          const rect = term.getBoundingClientRect();
          startW = rect.width;
          startH = rect.height;
          startLeft = rect.left;
          startTop = rect.top;
          startX = e.clientX;
          startY = e.clientY;
          document.addEventListener("mousemove", onResizeMove);
          document.addEventListener("mouseup", onResizeEnd);
          e.preventDefault();
          e.stopPropagation();
        }

        function onResizeMove(e) {
          if (!resizeActive) return;
          const { availableWidth, availableHeight } = viewportBounds();
          const minWidth = minTerminalWidth(availableWidth);
          const minHeight = minTerminalHeight(availableHeight);
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          let newW = startW;
          let newH = startH;
          let newLeft = startLeft;
          let newTop = startTop;

          if (resizeDir.includes("e")) {
            newW = Math.max(minWidth, startW + dx);
          }
          if (resizeDir.includes("w")) {
            newW = Math.max(minWidth, startW - dx);
            newLeft = startLeft + dx;
          }
          if (resizeDir.includes("s")) {
            newH = Math.max(minHeight, startH + dy);
          }
          if (resizeDir.includes("n")) {
            newH = Math.max(minHeight, startH - dy);
            newTop = startTop + dy;
          }

          term.style.width = `${newW}px`;
          term.style.height = `${newH}px`;
          term.style.left = `${newLeft}px`;
          term.style.top = `${newTop}px`;
          term.style.right = "auto";
          term.style.bottom = "auto";
          clampTerminalFrame({ persist: false });
        }

        function onResizeEnd() {
          resizeActive = false;
          document.removeEventListener("mousemove", onResizeMove);
          document.removeEventListener("mouseup", onResizeEnd);
          clampTerminalFrame({ persist: true });
        }

        handles.forEach((h) => h.addEventListener("mousedown", onResizeStart));
        window.addEventListener("resize", () => {
          clampTerminalFrame({ persist: true });
        });

        async function bootstrapActivity() {
          setStatus("SYNCING");
          try {
            const res = await fetch("/ui/activity?no_history=1&redact=1", {
              credentials: "same-origin",
              headers: { Accept: "application/json" },
              cache: "no-store",
            });
            if (res.ok) {
              const data = await res.json();
              afterId = Number(data.last_id || 0);
              sessionStorage.setItem("pfv-terminal-after", String(afterId));
              setStatus("LIVE");
            }
          } catch {
            // Ignore bootstrap errors.
            setStatus("OFFLINE");
          }
        }

        bootstrapActivity().finally(() => {
          setInterval(() => {
            poll(`/ui/activity?after_id=${afterId}&limit=200&redact=1`);
          }, 1000);
        });
      })();
    </script>
    {% endif %}
  </body>
</html>
