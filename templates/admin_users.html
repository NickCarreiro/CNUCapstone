{% extends "base.html" %}
{% block body_class %}page-admin-users{% endblock %}
{% block content %}
{% set total_users = rows|length %}
<section class="card hero-card admin-hero">
  <div class="eyebrow">System Administration</div>
  <h1>User management console</h1>
  <p class="muted">Manage user access, reset MFA, and control active sessions.</p>
  <div class="stat-row">
    <div class="stat-chip">
      <div class="stat-number">{{ total_users }}</div>
      <div class="stat-label">Total users</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ admin_count }}</div>
      <div class="stat-label">Administrators</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ totp_enabled_count }}</div>
      <div class="stat-label">MFA enabled</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ active_session_total }}</div>
      <div class="stat-label">Active sessions</div>
    </div>
  </div>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2>All users</h2>
    <div class="card-tools">
      <input type="text" id="adminUserFilter" placeholder="Search username..." />
    </div>
  </div>
  <p class="muted">Changes apply immediately and are logged in system activity.</p>

  {% if rows %}
  <div class="table-wrap">
    <table class="table" id="adminUsersTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Role</th>
          <th>MFA</th>
          <th>Active sessions</th>
          <th>Files</th>
          <th>Groups</th>
          <th>Created</th>
          <th>Last login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {% set target = row.user %}
        {% set disable_demotion = target.is_admin and admin_count <= 1 %}
        <tr class="admin-user-row">
          <td data-label="Username">{{ target.username }}</td>
          <td data-label="Role">{{ "Administrator" if target.is_admin else "Standard" }}</td>
          <td data-label="MFA">{{ "Enabled" if target.totp_enabled else "Disabled" }}</td>
          <td data-label="Active sessions">{{ row.active_sessions }}</td>
          <td data-label="Files">{{ row.file_count }}</td>
          <td data-label="Groups">{{ row.group_count }}</td>
          <td data-label="Created">{{ target.created_at }}</td>
          <td data-label="Last login">{{ target.last_login or "Never" }}</td>
          <td data-label="Actions" class="admin-action-cell">
            <div class="admin-action-grid">
              <form method="post" action="/ui/admin/users/{{ target.id }}/revoke-sessions" class="inline-form">
                <button type="submit" class="ghost">Revoke sessions</button>
              </form>
              <form method="post" action="/ui/admin/users/{{ target.id }}/reset-totp" class="inline-form">
                <button type="submit" class="ghost">Reset MFA</button>
              </form>
              <button
                type="button"
                class="ghost"
                data-admin-reset-password
                data-user-id="{{ target.id }}"
                data-username="{{ target.username }}"
              >
                Reset password
              </button>
              <form method="post" action="/ui/admin/users/{{ target.id }}/toggle-admin" class="inline-form">
                <button type="submit" {% if target.is_admin %}class="danger"{% endif %} {% if disable_demotion %}disabled{% endif %}>
                  {{ "Remove admin" if target.is_admin else "Make admin" }}
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="muted">No users found.</p>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<dialog id="adminResetPasswordDialog" class="modal">
  <form method="post" class="form compact" id="adminResetPasswordForm">
    <h2>Reset password</h2>
    <p class="muted" id="adminResetPasswordSubtitle">Set a new password for the selected user.</p>
    <label>
      <span>New password</span>
      <input type="password" name="password" id="adminResetPasswordValue" minlength="10" required />
    </label>
    <label>
      <span>Confirm password</span>
      <input type="password" name="confirm_password" id="adminResetPasswordConfirm" minlength="10" required />
    </label>
    <div class="modal-actions">
      <button type="button" class="ghost" id="adminResetPasswordGenerate">Generate</button>
      <button type="submit">Reset password</button>
      <button type="button" class="ghost" id="adminResetPasswordCancel">Cancel</button>
    </div>
  </form>
</dialog>

<script>
  const adminUserFilter = document.getElementById("adminUserFilter");
  const adminRows = document.querySelectorAll("#adminUsersTable .admin-user-row");
  adminUserFilter?.addEventListener("input", () => {
    const query = adminUserFilter.value.trim().toLowerCase();
    adminRows.forEach((row) => {
      row.hidden = query.length > 0 && !row.textContent.toLowerCase().includes(query);
    });
  });

  (function () {
    const dialog = document.getElementById("adminResetPasswordDialog");
    const form = document.getElementById("adminResetPasswordForm");
    const subtitle = document.getElementById("adminResetPasswordSubtitle");
    const pwd = document.getElementById("adminResetPasswordValue");
    const confirmPwd = document.getElementById("adminResetPasswordConfirm");
    const cancel = document.getElementById("adminResetPasswordCancel");
    const generate = document.getElementById("adminResetPasswordGenerate");

    if (!dialog || !form || !subtitle || !pwd || !confirmPwd) return;

    function closeDialog() {
      if (typeof dialog.close === "function") {
        dialog.close();
      } else {
        dialog.removeAttribute("open");
      }
    }

    cancel?.addEventListener("click", closeDialog);

    function randomPassword(length) {
      const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@$%*-_+?";
      const bytes = new Uint8Array(Math.max(12, length || 20));
      window.crypto.getRandomValues(bytes);
      let out = "";
      for (let i = 0; i < bytes.length; i++) {
        out += alphabet[bytes[i] % alphabet.length];
      }
      return out;
    }

    generate?.addEventListener("click", () => {
      if (!window.crypto || !window.crypto.getRandomValues) return;
      const value = randomPassword(22);
      pwd.value = value;
      confirmPwd.value = value;
      pwd.focus();
      pwd.select?.();
    });

    function openDialog(btn) {
      const userId = (btn?.dataset?.userId || "").trim();
      const username = (btn?.dataset?.username || "user").trim();
      if (!userId) return;

      form.action = `/ui/admin/users/${userId}/reset-password`;
      subtitle.textContent = `Reset password for ${username}. This will revoke all active sessions for that user.`;
      pwd.value = "";
      confirmPwd.value = "";

      if (typeof dialog.showModal === "function") {
        dialog.showModal();
      } else {
        dialog.setAttribute("open", "open");
      }
      pwd.focus();
    }

    document.querySelectorAll("[data-admin-reset-password]").forEach((btn) => {
      btn.addEventListener("click", () => openDialog(btn));
    });
  })();
</script>
{% endblock %}
