{% extends "base.html" %}
{% block body_class %}page-admin-help-detail{% endblock %}
{% block content %}
<section class="card hero-card admin-hero">
  <div class="eyebrow">System Administration</div>
  <h1>Support ticket #{{ ticket_display_id }}</h1>
  <p class="muted">Review user-submitted support requests and update status for the shared inbox.</p>
  <div class="stat-row">
    <div class="stat-chip">
      <div class="stat-number">{{ ticket.status }}</div>
      <div class="stat-label">Status</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ ticket.priority }}</div>
      <div class="stat-label">Priority</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ category_label }}</div>
      <div class="stat-label">Category</div>
    </div>
  </div>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2>Ticket details</h2>
    <div class="card-tools">
      <a class="pill ghost" href="/ui/admin/help">Back to inbox</a>
      <a class="pill ghost" href="/ui/help">User help page</a>
    </div>
  </div>
  <div class="soft-panel">
    <div class="meta-grid">
      <div class="meta-item">
        <div class="label">Ticket id</div>
        <code>#{{ ticket_display_id }}</code>
      </div>
      <div class="meta-item">
        <div class="label">Requester username</div>
        <div><code>{{ requester_username }}</code></div>
      </div>
      <div class="meta-item">
        <div class="label">Requester email</div>
        <div>{{ requester_email or "-" }}</div>
      </div>
      <div class="meta-item">
        <div class="label">Requester phone</div>
        <div>{{ requester_phone or "-" }}</div>
      </div>
      <div class="meta-item">
        <div class="label">Requester MFA</div>
        <div>{{ requester_mfa_summary }}</div>
      </div>
      <div class="meta-item">
        <div class="label">Subject</div>
        <div>{{ ticket.subject }}</div>
      </div>
      <div class="meta-item">
        <div class="label">Created</div>
        <time class="js-local-time" data-utc="{{ created_iso }}">{{ created_utc }}</time>
      </div>
      <div class="meta-item">
        <div class="label">Updated</div>
        <time class="js-local-time" data-utc="{{ updated_iso }}">{{ updated_utc }}</time>
      </div>
      <div class="meta-item">
        <div class="label">Assigned admin</div>
        <div>{{ ticket.assigned_admin.username if ticket.assigned_admin else "-" }}</div>
      </div>
      <div class="meta-item">
        <div class="label">Last admin update</div>
        <time class="js-local-time" data-utc="{{ last_admin_update_iso }}">{{ last_admin_update_utc }}</time>
      </div>
      <div class="meta-item">
        <div class="label">Closed</div>
        <time class="js-local-time" data-utc="{{ closed_iso }}">{{ closed_utc }}</time>
      </div>
    </div>
  </div>

  <div class="soft-panel">
    <div class="label">User details (full request body)</div>
    <pre class="mono-block">{{ description or "(empty)" }}</pre>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Shortcut actions</h2>
  </div>
  <div class="actions ticket-shortcut-actions">
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="take" />
      <button type="submit">Take ownership</button>
    </form>
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="need_info" />
      <button type="submit">Need user info</button>
    </form>
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="resolve" />
      <button type="submit">Resolve</button>
    </form>
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="close" />
      <button type="submit">Close</button>
    </form>
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="reopen" />
      <button type="submit" class="ghost">Reopen</button>
    </form>
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="escalate" />
      <button type="submit" class="ghost">Escalate urgent</button>
    </form>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Shortcut responses</h2>
  </div>
  <div class="actions ticket-shortcut-responses">
    {% for template in response_templates %}
    <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
      <input type="hidden" name="action" value="{{ template.shortcut }}" />
      <input type="hidden" name="response_template" value="{{ template.key }}" />
      <button type="submit" class="ghost">{{ template.label }}</button>
    </form>
    {% endfor %}
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Admin response and status</h2>
  </div>
  <form method="post" action="/ui/admin/help/{{ ticket.id }}/update" class="form compact admin-ticket-update-form">
    <label class="admin-ticket-field admin-ticket-field-status">
      <span>Status</span>
      <select name="status" required>
        {% for value in status_options %}
        <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="admin-ticket-field admin-ticket-field-priority">
      <span>Priority</span>
      <select name="priority" required>
        {% for value in priority_options %}
        <option value="{{ value }}" {% if ticket.priority == value %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="admin-ticket-field admin-ticket-field-category">
      <span>Category</span>
      <select name="category" required>
        {% for value, label in category_options.items() %}
        <option value="{{ value }}" {% if ticket.category == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="admin-ticket-field admin-ticket-field-template">
      <span>Response template</span>
      <select name="response_template" id="adminHelpResponseTemplate">
        <option value="">No template</option>
        {% for template in response_templates %}
        <option value="{{ template.key }}">{{ template.label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="admin-ticket-field admin-ticket-field-response">
      <span>Admin response (optional)</span>
      <textarea id="adminHelpReply" name="admin_reply" rows="9" maxlength="8000" placeholder="Write a response visible on the user's Help page.">{{ admin_reply }}</textarea>
    </label>
    <label class="toggle-row admin-ticket-field admin-ticket-field-append">
      <input type="checkbox" name="append_template" checked />
      <span>Append template to existing text (instead of replacing empty response only)</span>
    </label>
    <label class="toggle-row admin-ticket-field admin-ticket-field-clear">
      <input type="checkbox" name="clear_reply" />
      <span>Clear saved response</span>
    </label>
    <div class="inline-form admin-ticket-field admin-ticket-field-actions">
      <button type="submit">Save ticket update</button>
      <a class="pill ghost" href="/ui/admin/help/{{ ticket.id }}">Reset</a>
    </div>
  </form>
  <div class="actions ticket-template-actions">
    {% for template in response_templates %}
    <button
      type="button"
      class="ghost"
      data-help-template-key="{{ template.key }}"
    >
      Insert: {{ template.label }}
    </button>
    {% endfor %}
  </div>
</section>
<script>
  (function () {
    const textarea = document.getElementById("adminHelpReply");
    const templateSelect = document.getElementById("adminHelpResponseTemplate");
    if (!textarea || !templateSelect) return;
    const templates = {
      {% for template in response_templates %}
      "{{ template.key }}": {{ template.body|tojson }},
      {% endfor %}
    };
    const insertButtons = document.querySelectorAll("[data-help-template-key]");
    insertButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-help-template-key") || "";
        if (!key) return;
        templateSelect.value = key;
        const body = (templates[key] || "").trim();
        if (!body) return;
        const prefix = textarea.value.trim();
        textarea.value = prefix ? `${prefix}\n\n${body}` : body;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
      });
    });

    const timezone = (window.__pfvTimezone || "").trim();
    let formatter;
    try {
      formatter = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
        timeZone: timezone || undefined,
        timeZoneName: "short",
      });
    } catch {
      formatter = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
        timeZoneName: "short",
      });
    }

    document.querySelectorAll(".js-local-time").forEach((el) => {
      const iso = (el.getAttribute("data-utc") || "").trim();
      if (!iso) return;
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return;
      el.textContent = formatter.format(dt);
      el.setAttribute("title", `${iso} UTC`);
    });
  })();
</script>
{% endblock %}
