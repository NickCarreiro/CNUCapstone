{% extends "base.html" %}
{% block body_class %}page-messages{% endblock %}
{% block content %}
{% set thread_count = threads|length %}
{% set unread_count = unread_thread_total or 0 %}
<section class="card hero-card">
  <div class="eyebrow">Messages</div>
  <h1>Secure direct messaging</h1>
  <p class="muted">Conversations are encrypted at rest and scoped to authenticated users.</p>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card">
  <div class="messages-shell">
    <aside class="messages-rail">
      <div class="messages-rail-head">
        <div>
          <h2>Threads</h2>
          <p class="muted">{{ thread_count }} conversations</p>
        </div>
        <div class="messages-rail-badges">
          <span class="pill ghost">Unread {{ unread_count }}</span>
        </div>
      </div>
      <div class="messages-rail-search">
        <input type="text" id="dmThreadFilter" placeholder="Search conversations..." />
      </div>
      {% if threads %}
        <div class="messages-thread-list" id="dmThreadList">
          {% for item in threads %}
          <a
            class="messages-thread{% if item.thread_id == active_thread_id %} active{% endif %}"
            href="/ui/messages?thread={{ item.thread_id }}"
            data-thread-search="{{ (item.partner_username ~ ' ' ~ (item.partner_email or '') ~ ' ' ~ (item.latest_preview or ''))|lower }}"
          >
            <div class="messages-thread-top">
              <span class="messages-thread-user">{{ item.partner_username }}</span>
              {% if item.unread_count %}
                <span class="messages-thread-unread">{{ item.unread_count }}</span>
              {% endif %}
            </div>
            {% if item.partner_email %}
            <div class="muted messages-thread-contact">{{ item.partner_email }}</div>
            {% endif %}
            <div class="messages-thread-preview">{{ item.latest_preview }}</div>
            <div class="messages-thread-time">{{ item.latest_created_at_utc }}</div>
          </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No conversations yet. Start one below.</p>
      {% endif %}
    </aside>

    <div class="messages-main">
      <div class="messages-main-head">
        <div>
          <h2>
            {% if active_partner_username %}
            Chat with {{ active_partner_username }}
            {% else %}
            New conversation
            {% endif %}
          </h2>
          <p class="muted">
            {% if active_thread_id %}
            Active encrypted thread
            {% else %}
            Pick a thread or create a new one
            {% endif %}
          </p>
        </div>
        <button type="button" class="ghost" id="dmNewThread" aria-expanded="false" aria-controls="dmNewConversationPanel">New conversation</button>
      </div>

      <div class="messages-workspace" id="dmWorkspace">
        <div class="messages-chat-column">
          <div class="messages-stream" id="dmStream">
            {% if thread_messages %}
              {% for item in thread_messages %}
              <article class="messages-bubble{% if item.is_outbound %} outbound{% else %} inbound{% endif %}">
                <div class="messages-bubble-meta">
                  <span class="messages-bubble-sender">{{ item.sender_username }} to {{ item.recipient_username }}</span>
                  <span>{{ item.created_at_utc }}</span>
                </div>
                {% if item.body %}
                  <div class="messages-bubble-body">{{ item.body }}</div>
                {% endif %}
                {% if item.has_attachment %}
                  <div class="messages-bubble-attachment">
                    <a href="{{ item.attachment_url }}">{{ item.attachment_name }}</a>
                    <span class="muted">({{ item.attachment_size }} bytes)</span>
                  </div>
                {% endif %}
                <div class="messages-bubble-foot">
                  <span class="messages-bubble-receipt">{{ item.receipt }}</span>
                  {% if not item.is_outbound %}
                  <button
                    type="button"
                    class="ghost dm-report-btn"
                    data-message-id="{{ item.id }}"
                    data-sender="{{ item.sender_username }}"
                  >
                    Report
                  </button>
                  {% endif %}
                </div>
              </article>
              {% endfor %}
            {% else %}
              <div class="messages-empty-state">
                <p class="muted">No messages in this thread yet.</p>
              </div>
            {% endif %}
          </div>

          {% set has_active_thread = active_thread_id|length > 0 %}
          <section class="messages-reply">
            <form
              method="post"
              action="/ui/messages/send"
              enctype="multipart/form-data"
              class="messages-reply-form"
              id="dmReplyForm"
            >
              <input type="hidden" name="thread_id" id="dmReplyThreadId" value="{{ active_thread_id }}" />
              <input type="hidden" name="username" value="{{ active_partner_username }}" />
              <textarea
                name="message"
                id="dmReplyMessage"
                maxlength="4000"
                rows="3"
                placeholder="{% if has_active_thread %}Reply to {{ active_partner_username }}...{% else %}Select a conversation to reply...{% endif %}"
                {% if not has_active_thread %}disabled{% endif %}
              ></textarea>
              <div class="messages-reply-side">
                <input type="file" name="attachment" id="dmReplyAttachment" {% if not has_active_thread %}disabled{% endif %} />
                <button type="submit" {% if not has_active_thread %}disabled{% endif %}>Send</button>
              </div>
            </form>
          </section>
        </div>

        <section class="messages-new" id="dmNewConversationPanel" hidden>
          <div class="messages-new-head">
            <h3>Start new conversation</h3>
            <p class="muted">Enter recipient, message, and optional attachment.</p>
          </div>
          <form
            method="post"
            action="/ui/messages/send"
            enctype="multipart/form-data"
            class="form compact messages-new-form"
            id="dmNewForm"
          >
            <input type="hidden" name="thread_id" value="" />
            <label>
              <span>Recipient username</span>
              <input
                type="text"
                name="username"
                id="dmNewUsername"
                placeholder="teammate"
                autocomplete="off"
                required
              />
            </label>
            <label>
              <span>Message</span>
              <textarea
                name="message"
                id="dmNewMessage"
                maxlength="4000"
                rows="4"
                placeholder="Write your first message..."
                required
              ></textarea>
            </label>
            <label>
              <span>Attachment (optional, max 10 MB)</span>
              <input type="file" name="attachment" id="dmNewAttachment" />
            </label>
            <div class="messages-new-actions">
              <button type="submit">Start conversation</button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<dialog id="dmReportDialog" class="modal">
  <form method="post" action="/ui/messages/report" class="form compact" id="dmReportForm">
    <input type="hidden" name="message_id" id="dmReportMessageId" />
    <h2>Report direct message</h2>
    <p class="muted" id="dmReportSubtitle">An administrator will review this report. No automatic action is taken.</p>
    <label>
      <span>Reason</span>
      <select name="reason" id="dmReportReason" required>
        <option value="spam">Spam / unsolicited advertising</option>
        <option value="harassment">Harassment or hate speech</option>
        <option value="threat">Threats or violence</option>
        <option value="impersonation">Impersonation / fraud</option>
        <option value="sexual">Sexual content</option>
        <option value="other" selected>Other</option>
      </select>
    </label>
    <label>
      <span>Details (optional)</span>
      <textarea
        name="details"
        id="dmReportDetails"
        rows="4"
        maxlength="2000"
        placeholder="Optional context for the administrator..."
      ></textarea>
    </label>
    <div class="modal-actions">
      <button type="submit">Submit report</button>
      <button type="button" class="ghost" id="dmReportCancel">Cancel</button>
    </div>
  </form>
</dialog>

<script>
  (function () {
    const clearButton = document.getElementById("dmNewThread");
    const newPanel = document.getElementById("dmNewConversationPanel");
    const workspace = document.getElementById("dmWorkspace");
    const newUsername = document.getElementById("dmNewUsername");
    const newMessage = document.getElementById("dmNewMessage");
    const newAttachment = document.getElementById("dmNewAttachment");
    const replyThreadInput = document.getElementById("dmReplyThreadId");
    const stream = document.getElementById("dmStream");
    if (!clearButton || !newPanel) return;

    function setNewPanelOpen(open) {
      const next = !!open;
      newPanel.hidden = !next;
      workspace?.classList.toggle("is-new-open", next);
      clearButton.setAttribute("aria-expanded", next ? "true" : "false");
      clearButton.textContent = next ? "Close new conversation" : "New conversation";
      if (next) newUsername?.focus();
    }

    clearButton.addEventListener("click", () => {
      const open = clearButton.getAttribute("aria-expanded") === "true";
      setNewPanelOpen(!open);
      if (open) return;
      if (newUsername) newUsername.value = "";
      if (newMessage) newMessage.value = "";
      if (newAttachment) newAttachment.value = "";
    });

    if (stream) {
      stream.scrollTop = stream.scrollHeight;
    }

    const hasActiveThread = !!(replyThreadInput && replyThreadInput.value.trim());
    setNewPanelOpen(!hasActiveThread);
  })();

  (function () {
    const filter = document.getElementById("dmThreadFilter");
    const list = document.getElementById("dmThreadList");
    if (!filter || !list) return;
    const rows = Array.from(list.querySelectorAll(".messages-thread"));
    filter.addEventListener("input", () => {
      const q = filter.value.trim().toLowerCase();
      rows.forEach((row) => {
        const haystack = row.dataset.threadSearch || "";
        row.hidden = !!q && !haystack.includes(q);
      });
    });
  })();

  (function () {
    const dialog = document.getElementById("dmReportDialog");
    const form = document.getElementById("dmReportForm");
    const messageIdInput = document.getElementById("dmReportMessageId");
    const subtitle = document.getElementById("dmReportSubtitle");
    const reasonInput = document.getElementById("dmReportReason");
    const detailsInput = document.getElementById("dmReportDetails");
    const cancel = document.getElementById("dmReportCancel");

    if (!dialog || !form || !messageIdInput || !subtitle || !reasonInput || !detailsInput) return;

    function closeDialog() {
      if (typeof dialog.close === "function") {
        dialog.close();
      } else {
        dialog.removeAttribute("open");
      }
    }

    cancel?.addEventListener("click", closeDialog);

    function openDialog(btn) {
      const messageId = (btn?.dataset?.messageId || "").trim();
      if (!messageId) return;
      const sender = (btn?.dataset?.sender || "user").trim();

      messageIdInput.value = messageId;
      reasonInput.value = "other";
      detailsInput.value = "";

      let snippet = "";
      const article = btn.closest(".messages-bubble");
      const bodyEl = article ? article.querySelector(".messages-bubble-body") : null;
      if (bodyEl && bodyEl.textContent) {
        snippet = bodyEl.textContent.trim().replace(/\s+/g, " ");
        if (snippet.length > 180) snippet = `${snippet.slice(0, 177)}...`;
      }
      subtitle.textContent = snippet
        ? `Reporting message from ${sender}: "${snippet}"`
        : `Reporting message from ${sender}. No automatic action is taken.`;

      if (typeof dialog.showModal === "function") {
        dialog.showModal();
      } else {
        dialog.setAttribute("open", "open");
      }
    }

    document.querySelectorAll(".dm-report-btn").forEach((btn) => {
      btn.addEventListener("click", () => openDialog(btn));
    });
  })();
</script>
{% endblock %}
