{% extends "base.html" %}
{% block body_class %}page-messages{% endblock %}
{% block content %}
{% set thread_count = threads|length %}
{% set unread_count = unread_thread_total or 0 %}
<section class="card hero-card">
  <div class="eyebrow">Messages</div>
  <h1>Secure direct messaging</h1>
  <p class="muted">Conversations are encrypted at rest and scoped to authenticated users.</p>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card">
  <div class="messages-shell">
    <aside class="messages-rail">
      <div class="messages-rail-head">
        <div>
          <h2>Threads</h2>
          <p class="muted">{{ thread_count }} conversations</p>
        </div>
        <div class="messages-rail-badges">
          <span class="pill ghost">Unread {{ unread_count }}</span>
        </div>
      </div>
      <div class="messages-rail-search">
        <input type="text" id="dmThreadFilter" placeholder="Search conversations..." />
      </div>
      {% if threads %}
        <div class="messages-thread-list" id="dmThreadList">
          {% for item in threads %}
          <a
            class="messages-thread{% if item.thread_id == active_thread_id %} active{% endif %}"
            href="/ui/messages?thread={{ item.thread_id }}"
            data-thread-search="{{ (item.partner_username ~ ' ' ~ (item.partner_email or '') ~ ' ' ~ (item.latest_preview or ''))|lower }}"
          >
            <div class="messages-thread-top">
              <span class="messages-thread-user">{{ item.partner_username }}</span>
              {% if item.unread_count %}
                <span class="messages-thread-unread">{{ item.unread_count }}</span>
              {% endif %}
            </div>
            {% if item.partner_email %}
            <div class="muted messages-thread-contact">{{ item.partner_email }}</div>
            {% endif %}
            <div class="messages-thread-preview">{{ item.latest_preview }}</div>
            <div class="messages-thread-time">{{ item.latest_created_at_utc }}</div>
          </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No conversations yet. Start one below.</p>
      {% endif %}
    </aside>

    <div class="messages-main">
      <div class="messages-main-head">
        <div>
          <h2>
            {% if active_partner_username %}
            Chat with {{ active_partner_username }}
            {% else %}
            New conversation
            {% endif %}
          </h2>
          <p class="muted">
            {% if active_thread_id %}
            Active encrypted thread
            {% else %}
            Pick a thread or create a new one
            {% endif %}
          </p>
        </div>
        <button type="button" class="ghost" id="dmNewThread" aria-expanded="false" aria-controls="dmNewConversationPanel">New conversation</button>
      </div>

      <div class="messages-workspace" id="dmWorkspace">
        <div class="messages-chat-column">
          <div class="messages-stream" id="dmStream">
            {% if thread_messages %}
              {% for item in thread_messages %}
              <article
                class="messages-bubble{% if item.is_outbound %} outbound{% else %} inbound{% endif %}"
                data-message-id="{{ item.id }}"
              >
                <div class="messages-bubble-meta">
                  <span class="messages-bubble-sender">{{ item.sender_username }} to {{ item.recipient_username }}</span>
                  <span>{{ item.created_at_utc }}</span>
                </div>
                {% if item.body %}
                  <div class="messages-bubble-body">{{ item.body }}</div>
                {% endif %}
                {% if item.has_attachment %}
                  <div class="messages-bubble-attachment">
                    <a
                      href="{{ item.attachment_preview_url or item.attachment_url }}"
                      class="dm-attachment-link"
                      data-message-id="{{ item.id }}"
                      data-attachment-name="{{ item.attachment_name }}"
                      data-attachment-size="{{ item.attachment_size }}"
                      data-attachment-mime="{{ item.attachment_mime_type }}"
                      data-created-at="{{ item.created_at_utc }}"
                      data-preview-url="{{ item.attachment_preview_url or item.attachment_url }}"
                      data-download-url="{{ item.attachment_download_url or item.attachment_url }}"
                    >
                      {{ item.attachment_name }}
                    </a>
                    <span class="muted">({{ item.attachment_size }} bytes)</span>
                  </div>
                {% endif %}
                <div class="messages-bubble-foot">
                  <span class="messages-bubble-receipt">{{ item.receipt }}</span>
                  {% if not item.is_outbound %}
                  <button
                    type="button"
                    class="ghost dm-report-btn"
                    data-message-id="{{ item.id }}"
                    data-sender="{{ item.sender_username }}"
                  >
                    Report
                  </button>
                  {% endif %}
                </div>
              </article>
              {% endfor %}
            {% else %}
              <div class="messages-empty-state">
                <p class="muted">No messages in this thread yet.</p>
              </div>
            {% endif %}
          </div>

          {% set has_active_thread = active_thread_id|length > 0 %}
          <section class="messages-reply">
            <form
              method="post"
              action="/ui/messages/send"
              enctype="multipart/form-data"
              class="messages-reply-form"
              id="dmReplyForm"
            >
              <input type="hidden" name="thread_id" id="dmReplyThreadId" value="{{ active_thread_id }}" />
              <input type="hidden" name="username" value="{{ active_partner_username }}" />
              <textarea
                name="message"
                id="dmReplyMessage"
                maxlength="4000"
                rows="3"
                placeholder="{% if has_active_thread %}Reply to {{ active_partner_username }}...{% else %}Select a conversation to reply...{% endif %}"
                {% if not has_active_thread %}disabled{% endif %}
              ></textarea>
              <div class="messages-reply-side">
                <input type="file" name="attachment" id="dmReplyAttachment" {% if not has_active_thread %}disabled{% endif %} />
                <button type="submit" {% if not has_active_thread %}disabled{% endif %}>Send</button>
              </div>
            </form>
          </section>
        </div>

        <section class="messages-new" id="dmNewConversationPanel" hidden>
          <div class="messages-new-head">
            <h3>Start new conversation</h3>
            <p class="muted">Enter recipient, message, and optional attachment.</p>
          </div>
          <form
            method="post"
            action="/ui/messages/send"
            enctype="multipart/form-data"
            class="form compact messages-new-form"
            id="dmNewForm"
          >
            <input type="hidden" name="thread_id" value="" />
            <label>
              <span>Recipient username</span>
              <input
                type="text"
                name="username"
                id="dmNewUsername"
                placeholder="teammate"
                autocomplete="off"
                required
              />
            </label>
            <label>
              <span>Message</span>
              <textarea
                name="message"
                id="dmNewMessage"
                maxlength="4000"
                rows="4"
                placeholder="Write your first message..."
                required
              ></textarea>
            </label>
            <label>
              <span>Attachment (optional, max 10 MB)</span>
              <input type="file" name="attachment" id="dmNewAttachment" />
            </label>
            <div class="messages-new-actions">
              <button type="submit">Start conversation</button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<dialog id="dmReportDialog" class="modal">
  <form method="post" action="/ui/messages/report" class="form compact" id="dmReportForm">
    <input type="hidden" name="message_id" id="dmReportMessageId" />
    <h2>Report direct message</h2>
    <p class="muted" id="dmReportSubtitle">An administrator will review this report. No automatic action is taken.</p>
    <label>
      <span>Reason</span>
      <select name="reason" id="dmReportReason" required>
        <option value="spam">Spam / unsolicited advertising</option>
        <option value="harassment">Harassment or hate speech</option>
        <option value="threat">Threats or violence</option>
        <option value="impersonation">Impersonation / fraud</option>
        <option value="sexual">Sexual content</option>
        <option value="other" selected>Other</option>
      </select>
    </label>
    <label>
      <span>Details (optional)</span>
      <textarea
        name="details"
        id="dmReportDetails"
        rows="4"
        maxlength="2000"
        placeholder="Optional context for the administrator..."
      ></textarea>
    </label>
    <div class="modal-actions">
      <button type="submit">Submit report</button>
      <button type="button" class="ghost" id="dmReportCancel">Cancel</button>
    </div>
  </form>
</dialog>

<dialog id="dmAttachmentPreviewDialog" class="modal modal-wide dm-preview-dialog">
  <div class="modal-header">
    <div class="modal-header-text">
      <h2 id="dmAttachmentPreviewTitle">Attachment preview</h2>
      <p class="muted" id="dmAttachmentPreviewSubtitle"></p>
    </div>
    <div class="modal-header-actions">
      <a class="pill" id="dmAttachmentPreviewOpen" target="_blank" rel="noopener">Open</a>
      <a class="pill" id="dmAttachmentPreviewDownload" target="_blank" rel="noopener">Download</a>
      <button type="button" class="ghost" id="dmAttachmentPreviewClose">Close</button>
    </div>
  </div>
  <div class="dm-preview-body">
    <aside class="dm-preview-conversation" id="dmAttachmentConversation">
      <div class="dm-preview-conversation-head">Conversation context</div>
      <div class="dm-preview-conversation-list" id="dmAttachmentConversationList"></div>
    </aside>
    <section class="dm-preview-frame-wrap">
      <iframe id="dmAttachmentPreviewFrame" title="Message attachment preview"></iframe>
      <p class="muted" id="dmAttachmentPreviewFallback">
        If preview does not load, use Open (new tab) or Download.
      </p>
    </section>
  </div>
</dialog>

<div class="context-menu" id="dmAttachmentMenu" hidden role="menu" aria-label="Attachment actions">
  <div class="context-menu-header">
    <div class="context-menu-title">Attachment</div>
    <button type="button" class="ghost context-menu-close" data-action="close" aria-label="Close menu">Esc</button>
  </div>
  <div class="context-menu-body">
    <div class="context-menu-section">
      <div class="context-menu-kicker">Actions</div>
      <button type="button" class="context-menu-item" data-action="preview">Preview</button>
      <button type="button" class="context-menu-item" data-action="download">Download</button>
    </div>
  </div>
</div>

<script>
  (function () {
    const clearButton = document.getElementById("dmNewThread");
    const newPanel = document.getElementById("dmNewConversationPanel");
    const workspace = document.getElementById("dmWorkspace");
    const newUsername = document.getElementById("dmNewUsername");
    const newMessage = document.getElementById("dmNewMessage");
    const newAttachment = document.getElementById("dmNewAttachment");
    const replyThreadInput = document.getElementById("dmReplyThreadId");
    const stream = document.getElementById("dmStream");
    if (!clearButton || !newPanel) return;

    function setNewPanelOpen(open) {
      const next = !!open;
      newPanel.hidden = !next;
      workspace?.classList.toggle("is-new-open", next);
      clearButton.setAttribute("aria-expanded", next ? "true" : "false");
      clearButton.textContent = next ? "Close new conversation" : "New conversation";
      if (next) newUsername?.focus();
    }

    clearButton.addEventListener("click", () => {
      const open = clearButton.getAttribute("aria-expanded") === "true";
      setNewPanelOpen(!open);
      if (open) return;
      if (newUsername) newUsername.value = "";
      if (newMessage) newMessage.value = "";
      if (newAttachment) newAttachment.value = "";
    });

    if (stream) {
      stream.scrollTop = stream.scrollHeight;
    }

    const hasActiveThread = !!(replyThreadInput && replyThreadInput.value.trim());
    setNewPanelOpen(!hasActiveThread);
  })();

  (function () {
    const filter = document.getElementById("dmThreadFilter");
    const list = document.getElementById("dmThreadList");
    if (!filter || !list) return;
    const rows = Array.from(list.querySelectorAll(".messages-thread"));
    filter.addEventListener("input", () => {
      const q = filter.value.trim().toLowerCase();
      rows.forEach((row) => {
        const haystack = row.dataset.threadSearch || "";
        row.hidden = !!q && !haystack.includes(q);
      });
    });
  })();

  (function () {
    const menu = document.getElementById("dmAttachmentMenu");
    const dialog = document.getElementById("dmAttachmentPreviewDialog");
    const previewFrame = document.getElementById("dmAttachmentPreviewFrame");
    const previewTitle = document.getElementById("dmAttachmentPreviewTitle");
    const previewSubtitle = document.getElementById("dmAttachmentPreviewSubtitle");
    const previewOpen = document.getElementById("dmAttachmentPreviewOpen");
    const previewDownload = document.getElementById("dmAttachmentPreviewDownload");
    const previewClose = document.getElementById("dmAttachmentPreviewClose");
    const conversationList = document.getElementById("dmAttachmentConversationList");
    if (!menu || !dialog || !previewFrame || !previewTitle || !previewSubtitle || !previewOpen || !previewDownload || !conversationList) {
      return;
    }

    const closeButton = menu.querySelector("[data-action='close']");
    const previewButton = menu.querySelector("[data-action='preview']");
    const downloadButton = menu.querySelector("[data-action='download']");
    const links = Array.from(document.querySelectorAll(".dm-attachment-link"));
    const bubbles = Array.from(document.querySelectorAll(".messages-bubble"));

    let activeLink = null;
    let previewUrl = "";
    let downloadUrl = "";

    function formatBytes(bytesRaw) {
      const bytes = Number(bytesRaw || 0);
      if (!Number.isFinite(bytes) || bytes <= 0) return "size unknown";
      const units = ["B", "KB", "MB", "GB"];
      let value = bytes;
      let unit = units[0];
      for (const current of units) {
        unit = current;
        if (value < 1024 || current === units[units.length - 1]) break;
        value /= 1024;
      }
      if (unit === "B") return `${Math.round(value)} B`;
      return `${value.toFixed(2)} ${unit}`;
    }

    function buildConversationContext(messageId) {
      conversationList.replaceChildren();
      if (!bubbles.length) {
        const empty = document.createElement("p");
        empty.className = "muted";
        empty.textContent = "No conversation context available.";
        conversationList.appendChild(empty);
        return;
      }

      let focusIndex = bubbles.findIndex((row) => (row.dataset.messageId || "").trim() === messageId);
      if (focusIndex < 0) focusIndex = bubbles.length - 1;
      const start = Math.max(0, focusIndex - 3);
      const end = Math.min(bubbles.length, focusIndex + 4);

      const fragment = document.createDocumentFragment();
      for (let idx = start; idx < end; idx += 1) {
        const row = bubbles[idx];
        const item = document.createElement("article");
        item.className = "dm-preview-line";
        if (row.classList.contains("outbound")) item.classList.add("outbound");
        if (idx === focusIndex) item.classList.add("is-active");

        const metaText = (row.querySelector(".messages-bubble-meta")?.textContent || "").trim().replace(/\s+/g, " ");
        const bodyText = (row.querySelector(".messages-bubble-body")?.textContent || "").trim().replace(/\s+/g, " ");
        const attachmentText = (row.querySelector(".messages-bubble-attachment .dm-attachment-link")?.textContent || "")
          .trim()
          .replace(/\s+/g, " ");

        let previewText = bodyText;
        if (!previewText && attachmentText) previewText = `Attachment: ${attachmentText}`;
        if (!previewText) previewText = "(no message body)";
        if (previewText.length > 240) previewText = `${previewText.slice(0, 237)}...`;

        const meta = document.createElement("div");
        meta.className = "dm-preview-line-meta";
        meta.textContent = metaText || "Message";

        const content = document.createElement("div");
        content.className = "dm-preview-line-body";
        content.textContent = previewText;

        item.append(meta, content);
        fragment.appendChild(item);
      }

      conversationList.appendChild(fragment);
      const active = conversationList.querySelector(".dm-preview-line.is-active");
      active?.scrollIntoView({ block: "nearest" });
    }

    function closePreviewDialog() {
      previewFrame.removeAttribute("src");
      if (typeof dialog.close === "function") {
        dialog.close();
      } else {
        dialog.removeAttribute("open");
      }
    }

    function closeMenu() {
      menu.hidden = true;
      activeLink = null;
      previewUrl = "";
      downloadUrl = "";
    }

    function openMenu(x, y, nextPreviewUrl, nextDownloadUrl) {
      previewUrl = String(nextPreviewUrl || "").trim();
      if (!previewUrl) return;
      downloadUrl = String(nextDownloadUrl || "").trim();
      if (!downloadUrl) {
        const separator = previewUrl.includes("?") ? "&" : "?";
        downloadUrl = `${previewUrl}${separator}download=1`;
      }

      menu.hidden = false;
      menu.style.left = "0px";
      menu.style.top = "0px";

      const menuWidth = Math.ceil(menu.offsetWidth || 220);
      const menuHeight = Math.ceil(menu.offsetHeight || 120);
      const maxX = Math.max(8, window.innerWidth - menuWidth - 8);
      const maxY = Math.max(8, window.innerHeight - menuHeight - 8);
      const finalX = Math.min(Math.max(8, Math.round(x)), maxX);
      const finalY = Math.min(Math.max(8, Math.round(y)), maxY);
      menu.style.left = `${finalX}px`;
      menu.style.top = `${finalY}px`;
    }

    function openPreviewFromLink(link) {
      const nextPreviewUrl = String(link?.dataset?.previewUrl || link?.getAttribute("href") || "").trim();
      if (!nextPreviewUrl) return;
      const nextDownloadUrl = String(link?.dataset?.downloadUrl || "").trim();
      const resolvedDownloadUrl = nextDownloadUrl || `${nextPreviewUrl}${nextPreviewUrl.includes("?") ? "&" : "?"}download=1`;
      const attachmentName = String(link?.dataset?.attachmentName || link?.textContent || "Attachment").trim();
      const attachmentMime = String(link?.dataset?.attachmentMime || "application/octet-stream").trim();
      const attachmentSize = formatBytes(link?.dataset?.attachmentSize || "");
      const createdAt = String(link?.dataset?.createdAt || "").trim();

      previewUrl = nextPreviewUrl;
      downloadUrl = resolvedDownloadUrl;
      previewOpen.setAttribute("href", previewUrl);
      previewDownload.setAttribute("href", downloadUrl);
      previewDownload.setAttribute("download", attachmentName || "attachment");

      previewTitle.textContent = attachmentName || "Attachment preview";
      previewSubtitle.textContent = `${attachmentSize} • ${attachmentMime}${createdAt ? ` • ${createdAt}` : ""}`;
      buildConversationContext(String(link?.dataset?.messageId || "").trim());
      previewFrame.setAttribute("src", previewUrl);

      if (typeof dialog.showModal === "function") {
        dialog.showModal();
      } else {
        dialog.setAttribute("open", "open");
      }
      closeMenu();
    }

    closeButton?.addEventListener("click", closeMenu);
    previewClose?.addEventListener("click", closePreviewDialog);

    previewButton?.addEventListener("click", () => {
      if (!activeLink) return closeMenu();
      openPreviewFromLink(activeLink);
    });

    downloadButton?.addEventListener("click", () => {
      if (!downloadUrl) return closeMenu();
      window.open(downloadUrl, "_blank", "noopener");
      closeMenu();
    });

    links.forEach((link) => {
      link.addEventListener("click", (event) => {
        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0) return;
        event.preventDefault();
        openPreviewFromLink(link);
      });

      link.addEventListener("contextmenu", (event) => {
        event.preventDefault();
        activeLink = link;
        const nextPreviewUrl = link.dataset.previewUrl || link.getAttribute("href") || "";
        const nextDownloadUrl = link.dataset.downloadUrl || "";
        openMenu(event.clientX, event.clientY, nextPreviewUrl, nextDownloadUrl);
      });
    });

    menu.addEventListener("contextmenu", (event) => {
      event.preventDefault();
    });

    document.addEventListener("click", (event) => {
      if (menu.hidden) return;
      if (event.target instanceof Element && menu.contains(event.target)) return;
      closeMenu();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape") return;
      closeMenu();
      closePreviewDialog();
    });

    window.addEventListener("resize", closeMenu, { passive: true });
    window.addEventListener("scroll", closeMenu, { passive: true });

    dialog.addEventListener("click", (event) => {
      if (event.target === dialog) {
        closePreviewDialog();
      }
    });
  })();

  (function () {
    const dialog = document.getElementById("dmReportDialog");
    const form = document.getElementById("dmReportForm");
    const messageIdInput = document.getElementById("dmReportMessageId");
    const subtitle = document.getElementById("dmReportSubtitle");
    const reasonInput = document.getElementById("dmReportReason");
    const detailsInput = document.getElementById("dmReportDetails");
    const cancel = document.getElementById("dmReportCancel");

    if (!dialog || !form || !messageIdInput || !subtitle || !reasonInput || !detailsInput) return;

    function closeDialog() {
      if (typeof dialog.close === "function") {
        dialog.close();
      } else {
        dialog.removeAttribute("open");
      }
    }

    cancel?.addEventListener("click", closeDialog);

    function openDialog(btn) {
      const messageId = (btn?.dataset?.messageId || "").trim();
      if (!messageId) return;
      const sender = (btn?.dataset?.sender || "user").trim();

      messageIdInput.value = messageId;
      reasonInput.value = "other";
      detailsInput.value = "";

      let snippet = "";
      const article = btn.closest(".messages-bubble");
      const bodyEl = article ? article.querySelector(".messages-bubble-body") : null;
      if (bodyEl && bodyEl.textContent) {
        snippet = bodyEl.textContent.trim().replace(/\s+/g, " ");
        if (snippet.length > 180) snippet = `${snippet.slice(0, 177)}...`;
      }
      subtitle.textContent = snippet
        ? `Reporting message from ${sender}: "${snippet}"`
        : `Reporting message from ${sender}. No automatic action is taken.`;

      if (typeof dialog.showModal === "function") {
        dialog.showModal();
      } else {
        dialog.setAttribute("open", "open");
      }
    }

    document.querySelectorAll(".dm-report-btn").forEach((btn) => {
      btn.addEventListener("click", () => openDialog(btn));
    });
  })();
</script>
{% endblock %}
