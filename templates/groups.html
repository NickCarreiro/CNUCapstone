{% extends "base.html" %}
{% block body_class %}page-groups{% endblock %}
{% block content %}
{% set membership_count = memberships|length %}
{% set invite_count = pending_invites|length %}
{% set thread_count = threads|length %}
{% set unread_count = unread_thread_total or 0 %}
<section class="card hero-card groups-hero">
  <div class="eyebrow">Collaboration Hub</div>
  <h1>Groups, invites, and secure messaging</h1>
  <p class="muted">Coordinate with members, handle invitations, and keep communication centralized.</p>
  <div class="stat-row">
    <div class="stat-chip">
      <div class="stat-number">{{ membership_count }}</div>
      <div class="stat-label">Memberships</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ invite_count }}</div>
      <div class="stat-label">Pending invites</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ thread_count }}</div>
      <div class="stat-label">Conversations</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ unread_count }}</div>
      <div class="stat-label">Unread messages</div>
    </div>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Create group</h2>
  </div>
  <p class="muted">Start a new shared workspace and invite your team.</p>

  <form method="post" action="/ui/groups/create" class="form compact">
    <label>
      <span>New group name</span>
      <input type="text" name="name" placeholder="engineering-team" required />
    </label>
    <button type="submit">Create group</button>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Your group memberships</h2>
  </div>
  {% if memberships %}
    <div class="table-wrap">
      <table class="table" id="groupsMembershipTable">
        <thead>
          <tr>
            <th>Group</th>
            <th>Role</th>
            <th>Joined</th>
            <th>Open</th>
          </tr>
        </thead>
        <tbody>
          {% for membership in memberships %}
          <tr>
            <td data-label="Group">{{ membership.group.name }}</td>
            <td data-label="Role">{{ membership.role }}</td>
            <td data-label="Joined">{{ membership.joined_at }}</td>
            <td data-label="Open"><a class="pill" href="/ui/groups/{{ membership.group.id }}">Open</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">You are not in any groups yet.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2>Pending invites</h2>
  </div>
  {% if pending_invites %}
    <div class="table-wrap">
      <table class="table" id="groupsInvitesTable">
        <thead>
          <tr>
            <th>Group</th>
            <th>Invited by</th>
            <th>Created</th>
            <th>Accept</th>
            <th>Decline</th>
          </tr>
        </thead>
        <tbody>
          {% for invite in pending_invites %}
          <tr>
            <td data-label="Group">{{ invite.group.name }}</td>
            <td data-label="Invited by">{{ invite.inviter.username }}</td>
            <td data-label="Created">{{ invite.created_at }}</td>
            <td data-label="Accept">
              <form method="post" action="/ui/groups/invites/{{ invite.id }}/accept" class="inline-form">
                <button type="submit">Accept</button>
              </form>
            </td>
            <td data-label="Decline">
              <form method="post" action="/ui/groups/invites/{{ invite.id }}/decline" class="inline-form">
                <button type="submit" class="danger">Decline</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No pending invites.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2>Direct messages</h2>
    <div class="card-tools">
      <span class="pill ghost">Unread: {{ unread_count }}</span>
    </div>
  </div>

  <div class="dm-layout">
    <aside class="dm-threads">
      <h3>Conversations</h3>
      {% if threads %}
        <div class="dm-thread-list">
          {% for item in threads %}
          <a
            class="dm-thread{% if item.thread_id == active_thread_id %} active{% endif %}"
            href="/ui/groups?thread={{ item.thread_id }}"
          >
            <div class="dm-thread-head">
              <span class="dm-thread-user">{{ item.partner_username }}</span>
              {% if item.unread_count %}
                <span class="dm-thread-unread">{{ item.unread_count }}</span>
              {% endif %}
            </div>
            <div class="dm-thread-preview">{{ item.latest_preview }}</div>
            <div class="dm-thread-time">{{ item.latest_created_at_utc }}</div>
          </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No conversations yet. Start one below.</p>
      {% endif %}
    </aside>

    <div class="dm-main">
      <form
        method="post"
        action="/ui/groups/messages/send"
        enctype="multipart/form-data"
        class="form compact dm-compose-form"
        id="dmSendForm"
        data-active-partner="{{ active_partner_username }}"
      >
        <input type="hidden" name="thread_id" id="dmThreadId" value="{{ active_thread_id }}" />
        <label>
          <span>Recipient username</span>
          <input
            type="text"
            name="username"
            id="dmUsername"
            value="{{ active_partner_username }}"
            placeholder="teammate"
            autocomplete="off"
          />
        </label>
        <label>
          <span>Message</span>
          <textarea name="message" id="dmMessage" maxlength="4000" rows="4" placeholder="Write a secure message..."></textarea>
        </label>
        <label>
          <span>Attachment (optional, max 10 MB)</span>
          <input type="file" name="attachment" id="dmAttachment" />
        </label>
        <div class="dm-compose-actions">
          <button type="submit">Send message</button>
          <button type="button" class="ghost" id="dmNewThread">New conversation</button>
        </div>
      </form>

      <div class="dm-stream">
        {% if thread_messages %}
          {% for item in thread_messages %}
          <article class="dm-message{% if item.is_outbound %} outbound{% else %} inbound{% endif %}">
            <div class="dm-message-meta">
              <span>{{ item.sender_username }} to {{ item.recipient_username }}</span>
              <span>{{ item.created_at_utc }}</span>
            </div>
            {% if item.body %}
              <div class="dm-message-body">{{ item.body }}</div>
            {% endif %}
            {% if item.has_attachment %}
              <div class="dm-attachment">
                <a href="{{ item.attachment_url }}">{{ item.attachment_name }}</a>
                <span class="muted">({{ item.attachment_size }} bytes)</span>
              </div>
            {% endif %}
            <div class="dm-receipt">{{ item.receipt }}</div>
          </article>
          {% endfor %}
        {% else %}
          <p class="muted">Select a conversation or start a new one to view messages.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const form = document.getElementById("dmSendForm");
    if (!form) return;

    const threadInput = document.getElementById("dmThreadId");
    const usernameInput = document.getElementById("dmUsername");
    const clearButton = document.getElementById("dmNewThread");
    const stream = document.querySelector(".dm-stream");
    const activePartner = (form.dataset.activePartner || "").trim().toLowerCase();

    function syncRecipientRequirement() {
      const hasThread = !!(threadInput && threadInput.value.trim());
      if (usernameInput) {
        usernameInput.required = !hasThread;
      }
    }

    usernameInput?.addEventListener("input", () => {
      const currentValue = usernameInput.value.trim().toLowerCase();
      if (threadInput && threadInput.value && activePartner && currentValue && currentValue !== activePartner) {
        threadInput.value = "";
      }
      syncRecipientRequirement();
    });

    clearButton?.addEventListener("click", () => {
      if (threadInput) threadInput.value = "";
      if (usernameInput) {
        usernameInput.value = "";
        usernameInput.focus();
      }
      const messageInput = document.getElementById("dmMessage");
      if (messageInput) messageInput.value = "";
      const attachmentInput = document.getElementById("dmAttachment");
      if (attachmentInput) attachmentInput.value = "";
      syncRecipientRequirement();
    });

    if (stream) {
      stream.scrollTop = stream.scrollHeight;
    }

    syncRecipientRequirement();
  })();
</script>
{% endblock %}
