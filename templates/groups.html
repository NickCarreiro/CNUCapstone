{% extends "base.html" %}
{% block body_class %}page-groups{% endblock %}
{% block content %}
{% set membership_count = memberships|length %}
{% set invite_count = pending_invites|length %}
{% set message_count = recent_messages|length %}
<section class="card hero-card groups-hero">
  <div class="eyebrow">Collaboration Hub</div>
  <h1>Groups, invites, and secure messaging</h1>
  <p class="muted">Coordinate with members, handle invitations, and keep communication centralized.</p>
  <div class="stat-row">
    <div class="stat-chip">
      <div class="stat-number">{{ membership_count }}</div>
      <div class="stat-label">Memberships</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ invite_count }}</div>
      <div class="stat-label">Pending invites</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ message_count }}</div>
      <div class="stat-label">Recent messages</div>
    </div>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Create group</h2>
  </div>
  <p class="muted">Start a new shared workspace and invite your team.</p>

  <form method="post" action="/ui/groups/create" class="form compact">
    <label>
      <span>New group name</span>
      <input type="text" name="name" placeholder="engineering-team" required />
    </label>
    <button type="submit">Create group</button>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Your group memberships</h2>
  </div>
  {% if memberships %}
    <div class="table-wrap">
      <table class="table" id="groupsMembershipTable">
        <thead>
          <tr>
            <th>Group</th>
            <th>Role</th>
            <th>Joined</th>
            <th>Open</th>
          </tr>
        </thead>
        <tbody>
          {% for membership in memberships %}
          <tr>
            <td data-label="Group">{{ membership.group.name }}</td>
            <td data-label="Role">{{ membership.role }}</td>
            <td data-label="Joined">{{ membership.joined_at }}</td>
            <td data-label="Open"><a class="pill" href="/ui/groups/{{ membership.group.id }}">Open</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">You are not in any groups yet.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2>Pending invites</h2>
  </div>
  {% if pending_invites %}
    <div class="table-wrap">
      <table class="table" id="groupsInvitesTable">
        <thead>
          <tr>
            <th>Group</th>
            <th>Invited by</th>
            <th>Created</th>
            <th>Accept</th>
            <th>Decline</th>
          </tr>
        </thead>
        <tbody>
          {% for invite in pending_invites %}
          <tr>
            <td data-label="Group">{{ invite.group.name }}</td>
            <td data-label="Invited by">{{ invite.inviter.username }}</td>
            <td data-label="Created">{{ invite.created_at }}</td>
            <td data-label="Accept">
              <form method="post" action="/ui/groups/invites/{{ invite.id }}/accept" class="inline-form">
                <button type="submit">Accept</button>
              </form>
            </td>
            <td data-label="Decline">
              <form method="post" action="/ui/groups/invites/{{ invite.id }}/decline" class="inline-form">
                <button type="submit" class="danger">Decline</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No pending invites.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2>Direct messages</h2>
  </div>

  <form method="post" action="/ui/groups/messages/send" class="form compact">
    <label>
      <span>Recipient username</span>
      <input type="text" name="username" required />
    </label>
    <label>
      <span>Message</span>
      <textarea name="message" maxlength="4000" rows="4" placeholder="Write a secure message..." required></textarea>
    </label>
    <button type="submit">Send</button>
  </form>

  {% if recent_messages %}
    <div class="table-wrap">
      <table class="table" id="groupsMessagesTable">
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Message</th>
            <th>Sent</th>
          </tr>
        </thead>
        <tbody>
          {% for item in recent_messages %}
          <tr>
            <td data-label="From">{{ item.sender_username }}</td>
            <td data-label="To">{{ item.recipient_username }}</td>
            <td data-label="Message">{{ item.body }}</td>
            <td data-label="Sent">{{ item.created_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No messages yet.</p>
  {% endif %}
</section>
{% endblock %}
