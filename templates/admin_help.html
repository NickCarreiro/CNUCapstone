{% extends "base.html" %}
{% block body_class %}page-admin-help{% endblock %}
{% block content %}
<section class="card hero-card admin-hero">
  <div class="eyebrow">System Administration</div>
  <h1>Help inbox</h1>
  <p class="muted">Shared support queue for all administrators.</p>
  <div class="stat-row">
    <div class="stat-chip">
      <div class="stat-number">{{ counts.total }}</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ counts.open }}</div>
      <div class="stat-label">Open</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ counts.in_progress }}</div>
      <div class="stat-label">In progress</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ counts.waiting_on_user }}</div>
      <div class="stat-label">Waiting</div>
    </div>
    <div class="stat-chip">
      <div class="stat-number">{{ counts.resolved }}</div>
      <div class="stat-label">Resolved</div>
    </div>
  </div>
</section>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}
{% if notice %}
<div class="alert admin-notice">{{ notice }}</div>
{% endif %}

<section class="card filters-card" id="adminHelpFiltersTab">
  <div class="card-header">
    <h2>Filters</h2>
    <div class="card-tools">
      <button
        type="button"
        class="ghost filter-toggle"
        data-collapse-target="adminHelpFiltersTab"
        data-collapse-label-open="Hide filters tab"
        data-collapse-label-closed="Show filters tab"
        aria-controls="adminHelpFiltersTab"
        aria-expanded="true"
      >
        Hide filters tab
      </button>
      <a class="pill ghost" href="/ui/admin/users">Admin users</a>
      <a class="pill ghost" href="/ui/admin/reports">Message reports</a>
    </div>
  </div>
  <form method="get" class="form compact filters-form">
    <label class="filter-field filter-field-sm">
      <span>Status</span>
      <select name="status">
        <option value="">Any</option>
        {% for value in status_options %}
        <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="filter-field filter-field-sm">
      <span>Priority</span>
      <select name="priority">
        <option value="">Any</option>
        {% for value in priority_options %}
        <option value="{{ value }}" {% if filters.priority == value %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="filter-field filter-field-lg">
      <span>Search (username or subject)</span>
      <input type="text" name="q" value="{{ filters.q }}" placeholder="username, subject" />
    </label>
    <label class="filter-field filter-field-xs">
      <span>Limit</span>
      <input type="number" name="limit" min="1" max="500" value="{{ filters.limit }}" />
    </label>
    <div class="inline-form filters-actions">
      <button type="submit">Apply filters</button>
      <a class="pill ghost" href="/ui/admin/help">Reset</a>
    </div>
  </form>
</section>

<section class="card">
  <div class="card-header">
    <h2>Ticket queue</h2>
    <div class="card-tools">
      <button
        type="button"
        class="ghost filter-toggle"
        data-collapse-target="adminHelpFiltersTab"
        data-collapse-label-open="Hide filters tab"
        data-collapse-label-closed="Show filters tab"
        data-collapse-visible="collapsed"
        aria-controls="adminHelpFiltersTab"
        aria-expanded="true"
        hidden
      >
        Show filters tab
      </button>
    </div>
  </div>

  {% if rows %}
  <div class="ticket-queue-list">
    {% for row in rows %}
    {% set ticket = row.ticket %}
    <article class="soft-panel ticket-queue-item">
      <div class="ticket-queue-head">
        <div class="ticket-queue-title">
          <div class="label">Ticket {{ ticket.id }}</div>
          <h3>{{ ticket.subject }}</h3>
        </div>
        <div class="ticket-queue-badges">
          <code>{{ ticket.status }}</code>
          <code>{{ ticket.priority }}</code>
          <span class="pill ghost">{{ row.category_label }}</span>
        </div>
      </div>

      <div class="ticket-queue-meta">
        <div class="meta-item">
          <div class="label">Requester username</div>
          <div><code>{{ row.requester_username }}</code></div>
        </div>
        <div class="meta-item">
          <div class="label">Requester email</div>
          <div>{{ row.requester_email or "-" }}</div>
        </div>
        <div class="meta-item">
          <div class="label">Requester MFA</div>
          <div>{{ row.requester_mfa_summary }}</div>
        </div>
        <div class="meta-item">
          <div class="label">Created</div>
          <div>{{ ticket.created_at.strftime("%Y-%m-%d %H:%M:%S UTC") if ticket.created_at else "-" }}</div>
        </div>
        <div class="meta-item">
          <div class="label">Updated</div>
          <div>{{ ticket.updated_at.strftime("%Y-%m-%d %H:%M:%S UTC") if ticket.updated_at else "-" }}</div>
        </div>
        <div class="meta-item">
          <div class="label">Assigned admin</div>
          <div>{{ row.assigned_admin_username or "-" }}</div>
        </div>
      </div>

      <div class="ticket-queue-preview">
        <div class="label">User details preview</div>
        <p>{{ row.description_preview }}</p>
      </div>
      {% if row.admin_reply_preview %}
      <div class="ticket-queue-preview">
        <div class="label">Latest admin response</div>
        <p>{{ row.admin_reply_preview }}</p>
      </div>
      {% endif %}

      <div class="ticket-queue-actions ticket-queue-actions-primary">
        <a class="pill" href="/ui/admin/help/{{ ticket.id }}">Open full ticket</a>
        {% for shortcut in shortcut_rows %}
        <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
          <input type="hidden" name="action" value="{{ shortcut.key }}" />
          <button type="submit" class="ghost">{{ shortcut.label }}</button>
        </form>
        {% endfor %}
      </div>

      <div class="ticket-queue-actions ticket-queue-actions-responses">
        <div class="label">Shortcut responses</div>
        {% for template in response_templates %}
        <form method="post" action="/ui/admin/help/{{ ticket.id }}/shortcut" class="inline-form">
          <input type="hidden" name="action" value="{{ template.shortcut }}" />
          <input type="hidden" name="response_template" value="{{ template.key }}" />
          <button type="submit" class="ghost">{{ template.label }}</button>
        </form>
        {% endfor %}
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <p class="muted">No support tickets matched the current filters.</p>
  {% endif %}
</section>
{% endblock %}
